<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ã‚«ãƒãƒãƒª & RE2 åˆ¤å®šãƒ„ãƒ¼ãƒ«ï¼ˆã‚¿ãƒƒãƒ—å…¥åŠ›ï¼‰</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111826; --panel2:#0f1622; --text:#e8eef7; --muted:#a7b3c7;
      --line:#243247; --btn:#1a2435; --btn2:#182033; --good:#26d07c; --warn:#ffcc66; --bad:#ff5d5d; --best:#b98cff;
      --chip:#162033;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Hiragino Sans", "Noto Sans JP", Arial, sans-serif;
      background:linear-gradient(180deg, #070b10 0%, var(--bg) 70%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,15,20,.86); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .title{ font-weight:700; font-size:14px; letter-spacing:.2px; }
    .sub{ font-size:12px; color:var(--muted); }
    .wrap{ padding:12px; max-width:1200px; margin:0 auto; }
    .grid{
      display:grid; gap:12px;
      grid-template-columns: 1.1fr .9fr;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns:1fr; }
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0; padding:12px 12px 10px;
      font-size:14px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .body{ padding:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1 1 auto; }
    .field{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      min-width: 160px;
    }
    .label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="number"], input[type="text"], select{
      width:100%;
      background:rgba(255,255,255,.04);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      font-size:14px;
      outline:none;
    }
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .seg button{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:.12s;
      flex: 1 1 auto;
      min-width: 120px;
    }
    .seg button:hover{ transform: translateY(-1px); }
    .seg button.active{
      border-color: rgba(185,140,255,.8);
      box-shadow: 0 0 0 3px rgba(185,140,255,.12);
    }
    .mini{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.2);
      font-size:13px;
      color:var(--text);
      user-select:none;
    }
    .pill .v{ font-weight:700; }
    .tapline{
      display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .tapbtns{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .btn{
      background:var(--btn2);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:.12s;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.good{ border-color: rgba(38,208,124,.5); }
    .btn.bad{ border-color: rgba(255,93,93,.5); }
    .btn.warn{ border-color: rgba(255,204,102,.55); }
    .btn.best{ border-color: rgba(185,140,255,.6); }
    .btn.small{ padding:8px 10px; font-size:12px; border-radius:10px; }
    .chip{
      background:var(--chip);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      margin-top:10px;
    }
    .chip h3{ margin:0 0 8px; font-size:13px; color:var(--muted); font-weight:600; }
    .rank{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.2);
      margin-bottom:10px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:.2px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .b-red{ color:var(--bad); border-color:rgba(255,93,93,.45); }
    .b-yellow{ color:var(--warn); border-color:rgba(255,204,102,.45); }
    .b-green{ color:var(--good); border-color:rgba(38,208,124,.45); }
    .b-purple{ color:var(--best); border-color:rgba(185,140,255,.55); }

    .reason{
      font-size:13px; color:var(--text);
      line-height:1.5;
      margin:8px 0 0;
    }
    .reason ul{ margin:8px 0 0 18px; color:var(--muted); }
    .hr{ height:1px; background:var(--line); margin:10px 0; }
    .hist{
      max-height: 360px;
      overflow:auto;
      padding-right:6px;
    }
    .hist .item{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
      font-size:12px;
    }
    .hist .item .t{ color:var(--text); line-height:1.35; }
    .hist .item .d{ color:var(--muted); font-size:11px; white-space:nowrap; }
    .hist .item .x{
      background:transparent; border:1px solid rgba(255,93,93,.4);
      color:var(--bad); border-radius:10px; padding:6px 8px; cursor:pointer;
    }
    .footerbar{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; align-items:center;
      margin-top:10px;
    }
    .note{ color:var(--muted); font-size:12px; line-height:1.4; }
    .two{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    @media (max-width:560px){ .two{ grid-template-columns:1fr; } }

    .tinyTabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tinyTabs button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
    }
    .tinyTabs button.active{
      border-color: rgba(185,140,255,.8);
      box-shadow: 0 0 0 3px rgba(185,140,255,.10);
    }

    .krow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
      font-size:12px;
    }
    .krow .left{ color:var(--text); }
    .krow .right{ color:var(--muted); }
  </style>
</head>
<body>
<header>
  <div>
    <div class="title">ã‚«ãƒãƒãƒª & RE2 åˆ¤å®šãƒ„ãƒ¼ãƒ«ï¼ˆå®Ÿæˆ¦å‘ã‘ï¼‰</div>
    <div class="sub">å½“æ—¥å±¥æ­´ã¯å³ã«è¡¨ç¤ºï¼ä¿å­˜ã¯ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰</div>
  </div>
  <div class="seg" style="gap:8px;">
    <button id="tabK" class="active" type="button">ã‚«ãƒãƒãƒª</button>
    <button id="tabR" type="button">RE2</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h2>
        <span id="leftTitle">å…¥åŠ›ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ä¸­å¿ƒï¼‰</span>
        <span class="mini">
          <span class="pill"><span>æ—¥ä»˜</span><span class="v" id="today"></span></span>
        </span>
      </h2>
      <div class="body" id="leftBody"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>
        <span>åˆ¤å®š & å½“æ—¥å±¥æ­´</span>
        <span class="mini">
          <button class="btn small" id="btnResetDay" type="button">å½“æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </span>
      </h2>
      <div class="body">
        <div id="judgeBox"></div>

        <div class="chip">
          <h3>å½“æ—¥å±¥æ­´ï¼ˆè¡¨ç¤º10ä»¶ / ä¿å­˜ã¯å…¨ä»¶ï¼‰</h3>
          <div class="hist" id="hist"></div>
          <div class="footerbar">
            <div class="mini">
              <button class="btn small" id="btnExport" type="button">JSONæ›¸ãå‡ºã—</button>
              <button class="btn small" id="btnImport" type="button">JSONèª­ã¿è¾¼ã¿</button>
              <input id="fileIn" type="file" accept="application/json" style="display:none;" />
            </div>
            <div class="note">â€» å±¥æ­´ã¯ç«¯æœ«ã”ã¨ï¼ˆåˆ¥ã‚¹ãƒãƒ›ã«ã¯è‡ªå‹•åŒæœŸã—ãªã„ï¼‰</div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Storage & Helpers
========================= */
const KEY = "kabare2_v2_re2full";
const todayStr = (() => {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
})();
document.getElementById("today").textContent = todayStr;

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function nowTs(){
  const d = new Date();
  return d.toLocaleTimeString("ja-JP", {hour:"2-digit", minute:"2-digit"});
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function fmtPct(x){ return (x==null || !isFinite(x)) ? "â€”" : `${x.toFixed(1)}%`; }
function safeInt(v){ const n = Number(String(v).replace(/[^\d\-]/g,"")); return isFinite(n) ? n : 0; }

/* =========================
   Defaults
========================= */
function defaultKState(){
  return {
    totalG: "",
    cz: { unmei:{a:0,s:0}, ikoma:{a:0,s:0}, biba:{a:0,s:0} },
    bonus: { sjo:0, epi:0, epi7:0, epiLast:null },
    char: { male:0, female:0 },
    midBell: { count:"", base:"" },
    notes: ""
  };
}
function initRE2Figs(){
  const list = [
    {key:"oddWeak", name:"ã‚¾ãƒ³ãƒ“(ç”·)/ã‚¾ãƒ³ãƒ“(å¥³)/ã‚¾ãƒ³ãƒ“çŠ¬", tag:"å¥‡æ•°ç¤ºå”†ï¼ˆå¼±ï¼‰", group:"ç™½ï¼ˆå¥‡æ•°ï¼‰"},
    {key:"oddStrong", name:"ã‚¤ãƒ“ãƒ¼/ãƒªãƒƒã‚«ãƒ¼/ãƒšã‚¤ãƒ«ãƒ˜ãƒƒãƒ‰", tag:"å¥‡æ•°ç¤ºå”†ï¼ˆå¼·ï¼‰", group:"ç™½ï¼ˆå¥‡æ•°ï¼‰"},
    {key:"evenWeak", name:"ãƒ¬ã‚ªãƒ³/ãƒãƒ¼ãƒ“ãƒ³/ç‰¹æ®Šéƒ¨éšŠ", tag:"å¶æ•°ç¤ºå”†ï¼ˆå¼±ï¼‰", group:"é’ï¼ˆå¶æ•°ï¼‰"},
    {key:"evenStrong", name:"ã‚¯ãƒ¬ã‚¢/ã‚·ã‚§ãƒªãƒ¼/ã‚¢ãƒãƒƒãƒˆ", tag:"å¶æ•°ç¤ºå”†ï¼ˆå¼·ï¼‰", group:"é’ï¼ˆå¶æ•°ï¼‰"},
    {key:"hiWeak", name:"ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆ/ã‚¨ã‚¤ãƒ€ï¼ˆã‚¹ãƒ¼ãƒ„ï¼‰", tag:"é«˜è¨­å®šç¤ºå”†ï¼ˆå¼±ï¼‰", group:"èµ¤ï¼ˆé«˜è¨­å®šï¼‰"},
    {key:"hiStrong", name:"ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆ/ã‚¨ã‚¤ãƒ€ï¼ˆãƒ‰ãƒ¬ã‚¹ï¼‰", tag:"é«˜è¨­å®šç¤ºå”†ï¼ˆå¼·ï¼‰", group:"èµ¤ï¼ˆé«˜è¨­å®šï¼‰"},
    {key:"deny1", name:"Gç¬¬1å½¢æ…‹", tag:"è¨­å®š1å¦å®š", group:"éŠ…ï¼ˆå¦å®šï¼‰"},
    {key:"deny2", name:"Gç¬¬2å½¢æ…‹", tag:"è¨­å®š2å¦å®š", group:"éŠ…ï¼ˆå¦å®šï¼‰"},
    {key:"deny3", name:"Gç¬¬3å½¢æ…‹", tag:"è¨­å®š3å¦å®š", group:"éŠ…ï¼ˆå¦å®šï¼‰"},
    {key:"deny4", name:"Gç¬¬4å½¢æ…‹", tag:"è¨­å®š4å¦å®š", group:"éŠ…ï¼ˆå¦å®šï¼‰"},
    {key:"ge3", name:"è±†è…", tag:"è¨­å®š3ä»¥ä¸Š", group:"éŠ€/é‡‘/ç´…è‘‰/è™¹ï¼ˆç¢ºå®šç³»ï¼‰"},
    {key:"ge4", name:"ãƒœã‚¹ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼", tag:"è¨­å®š4ä»¥ä¸Š", group:"éŠ€/é‡‘/ç´…è‘‰/è™¹ï¼ˆç¢ºå®šç³»ï¼‰"},
    {key:"ge5", name:"å…¨å“¡é›†åˆ", tag:"è¨­å®š5ä»¥ä¸Š", group:"éŠ€/é‡‘/ç´…è‘‰/è™¹ï¼ˆç¢ºå®šç³»ï¼‰"},
    {key:"eq6", name:"ã‚¨ãƒ³ã‚¿ãƒ©ã‚¤ã‚ªãƒ³", tag:"è¨­å®š6ç¢ºå®š", group:"éŠ€/é‡‘/ç´…è‘‰/è™¹ï¼ˆç¢ºå®šç³»ï¼‰"},
  ];
  const obj = {};
  for(const f of list) obj[f.key] = 0;
  obj._meta = list;
  return obj;
}
function defaultRState(){
  return {
    subTab: "input", // input / judge / history
    totalG: "",
    // CZ/AT
    cz: { count:0, win:0 },
    at: { count:0 }, // auto only
    // ATé–‹å§‹ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆATãƒ¬ãƒ™ãƒ«ã®ãƒ’ãƒ³ãƒˆï¼‰
    atStart: { police:0, sewer:0, lab:0, escape:0 },
    // ãƒªãƒ—ãƒ¬ã‚¤â†’CZï¼ˆå¿ƒéŸ³åˆ¥ï¼‰
    repCZ: { blue:0, green:0, red:0, purple:0 },
    // ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆï¼ˆç›®ã«è¦‹ãˆã‚‹ã®ã¯CZçªå…¥ã§OKï¼‰
    tyrant: { cz:0 },
    // ATç›´æ’ƒï¼ˆå¥‘æ©Ÿåˆ¥ï¼‰
    direct: { replay:0, weak:0, strong:0 },
    // ãƒ•ã‚£ã‚®ãƒ¥ã‚¢
    figs: initRE2Figs()
  };
}

/* =========================
   State
========================= */
function loadState(){
  const raw = localStorage.getItem(KEY);
  if(!raw){
    return { activeTab:"k", day: todayStr, k: defaultKState(), r: defaultRState(), history: [] };
  }
  try{
    const s = JSON.parse(raw);
    if(!s.k) s.k = defaultKState();
    if(!s.r) s.r = defaultRState();
    if(!Array.isArray(s.history)) s.history = [];
    if(!s.day) s.day = todayStr;
    if(!s.activeTab) s.activeTab = "k";
    if(!s.r.figs || !s.r.figs._meta){
      const fixed = initRE2Figs();
      if(s.r.figs){
        for(const k of Object.keys(fixed)){
          if(k==="_meta") continue;
          fixed[k] = Number(s.r.figs[k]||0);
        }
      }
      s.r.figs = fixed;
    }
    if(!s.r.subTab) s.r.subTab = "input";
    return s;
  }catch{
    return { activeTab:"k", day: todayStr, k: defaultKState(), r: defaultRState(), history: [] };
  }
}
let state = loadState();

// day rollover
if(state.day !== todayStr){
  state.day = todayStr;
  state.k = defaultKState();
  state.r = defaultRState();
  saveState();
}

function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }

function addHist(tab, text){
  const item = { id: uid(), day: todayStr, tab, text, ts: nowTs() };
  state.history.unshift(item);
  saveState();
  renderRight();
}
function delHist(id){
  state.history = state.history.filter(x => x.id !== id);
  saveState();
  renderRight();
}
function resetDay(){
  state.history = state.history.filter(x => x.day !== todayStr);
  state.k = defaultKState();
  state.r = defaultRState();
  saveState();
  renderAll();
}
function downloadJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* =========================
   Tabs
========================= */
const tabK = document.getElementById("tabK");
const tabR = document.getElementById("tabR");
tabK.addEventListener("click", ()=>{ state.activeTab="k"; saveState(); renderAll(); });
tabR.addEventListener("click", ()=>{ state.activeTab="r"; saveState(); renderAll(); });

/* =========================
   UI helpers
========================= */
function mkField(label, innerEl){
  const f = document.createElement("div");
  f.className = "field";
  const l = document.createElement("div");
  l.className = "label";
  l.textContent = label;
  f.appendChild(l);
  f.appendChild(innerEl);
  return f;
}
function mkBtn(text, cls, onClick){
  const b = document.createElement("button");
  b.type="button";
  b.className = `btn ${cls||""}`.trim();
  b.textContent = text;
  b.onclick = onClick;
  return b;
}
function mkSmall(text, cls, onClick){
  const b = document.createElement("button");
  b.type="button";
  b.className = `btn small ${cls||""}`.trim();
  b.textContent = text;
  b.onclick = onClick;
  return b;
}
function mkPill(html){
  const p = document.createElement("div");
  p.className="pill";
  p.innerHTML = html;
  return p;
}

/* =========================
   Render
========================= */
function renderAll(){
  tabK.classList.toggle("active", state.activeTab==="k");
  tabR.classList.toggle("active", state.activeTab==="r");

  const leftTitle = document.getElementById("leftTitle");
  leftTitle.textContent = (state.activeTab==="k") ? "å…¥åŠ›ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ä¸­å¿ƒï¼‰" : "RE2ï¼šå…¥åŠ›ï¼ç¢ºèªï¼å±¥æ­´";
  renderLeft();
  renderRight();
}
function renderLeft(){
  const root = document.getElementById("leftBody");
  root.innerHTML = "";
  if(state.activeTab === "k"){
    root.appendChild(renderKabaneriLeft());
  }else{
    root.appendChild(renderRE2Left());
  }
}

/* =========================
   Kabaneri (ã»ã¼ãã®ã¾ã¾)
========================= */
function renderKabaneriLeft(){
  const box = document.createElement("div");

  const r1 = document.createElement("div"); r1.className="row";
  const g = document.createElement("input");
  g.type="text"; g.placeholder="ä¾‹ï¼‰5200ï¼ˆæ•°å­—ã ã‘ï¼‰";
  g.value = state.k.totalG;
  g.oninput = () => { state.k.totalG = g.value.replace(/[^\d]/g,""); saveState(); renderRight(); };
  r1.appendChild(mkField("ç·ã‚²ãƒ¼ãƒ æ•°ï¼ˆä»»æ„ï¼‰", g));
  box.appendChild(r1);

  const czBox = document.createElement("div"); czBox.className="chip";
  czBox.innerHTML = `<h3>CZï¼ˆå‡ºç¾ï¼æˆåŠŸï¼‰</h3>`;
  const two = document.createElement("div"); two.className="two";

  const makeCZ = (label, key) => {
    const c = state.k.cz[key];
    const field = document.createElement("div");
    field.className="field";
    field.innerHTML = `<div class="label">${label}</div>`;
    const line = document.createElement("div"); line.className="tapline";
    const pill = mkPill(`<span>å‡ºç¾</span><span class="v">${c.a}</span><span style="opacity:.6;">ï½œ</span><span>æˆåŠŸ</span><span class="v">${c.s}</span>`);
    line.appendChild(pill);

    const btns = document.createElement("div"); btns.className="tapbtns";

    btns.appendChild(mkSmall("å‡ºç¾ +1","good", ()=>{
      c.a += 1; saveState(); addHist("k", `${label} å‡ºç¾ +1`); renderAll();
    }));
    btns.appendChild(mkSmall("æˆåŠŸ +1","best", ()=>{
      c.a += 1; c.s += 1; saveState(); addHist("k", `${label} æˆåŠŸ +1`); renderAll();
    }));
    btns.appendChild(mkSmall("âˆ’1","bad", ()=>{
      c.a = Math.max(0, c.a-1);
      c.s = Math.min(c.s, c.a);
      saveState(); addHist("k", `${label} âˆ’1`); renderAll();
    }));

    line.appendChild(btns);
    field.appendChild(line);
    return field;
  };

  two.appendChild(makeCZ("ç„¡åCZ", "unmei"));
  two.appendChild(makeCZ("ç”Ÿé§’CZ", "ikoma"));
  two.appendChild(makeCZ("ç¾é¦¬CZ", "biba"));
  czBox.appendChild(two);
  box.appendChild(czBox);

  const bBox = document.createElement("div"); bBox.className="chip";
  bBox.innerHTML = `<h3>ãƒœãƒ¼ãƒŠã‚¹</h3>`;
  const bTwo = document.createElement("div"); bTwo.className="two";

  // é§¿åŸ
  const sjo = document.createElement("div"); sjo.className="field";
  sjo.innerHTML = `<div class="label">é§¿åŸãƒœãƒ¼ãƒŠã‚¹</div>`;
  const sjoLine = document.createElement("div"); sjoLine.className="tapline";
  sjoLine.appendChild(mkPill(`<span class="v">${state.k.bonus.sjo}</span>`));
  const sjoBtns = document.createElement("div"); sjoBtns.className="tapbtns";
  sjoBtns.appendChild(mkSmall("+1","good", ()=>{ state.k.bonus.sjo++; saveState(); addHist("k","é§¿åŸ +1"); renderAll(); }));
  sjoBtns.appendChild(mkSmall("+10","good", ()=>{ state.k.bonus.sjo+=10; saveState(); addHist("k","é§¿åŸ +10"); renderAll(); }));
  sjoBtns.appendChild(mkSmall("âˆ’1","bad", ()=>{ state.k.bonus.sjo=Math.max(0,state.k.bonus.sjo-1); saveState(); addHist("k","é§¿åŸ âˆ’1"); renderAll(); }));
  sjoLine.appendChild(sjoBtns);
  sjo.appendChild(sjoLine);
  bTwo.appendChild(sjo);

  // EP
  const epiField = document.createElement("div"); epiField.className="field";
  epiField.innerHTML = `<div class="label">ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ï¼ˆè©±æ•°ã‚¿ãƒƒãƒ— / 7è©±ã¯4ä»¥ä¸Šç¢ºå®šï¼‰</div>`;
  const epiLine = document.createElement("div"); epiLine.className="tapline";
  epiLine.appendChild(mkPill(`<span>EP</span><span class="v">${state.k.bonus.epi}</span><span style="opacity:.6;">ï½œ</span><span>7è©±</span><span class="v">${state.k.bonus.epi7}</span>`));
  const epiBtns = document.createElement("div"); epiBtns.className="tapbtns";
  epiBtns.appendChild(mkSmall("âˆ’1","bad", ()=>{
    state.k.bonus.epi = Math.max(0, state.k.bonus.epi-1);
    if(state.k.bonus.epiLast===7) state.k.bonus.epi7 = Math.max(0, state.k.bonus.epi7-1);
    saveState(); addHist("k","EP âˆ’1"); renderAll();
  }));
  epiLine.appendChild(epiBtns);
  epiField.appendChild(epiLine);
  epiField.appendChild(document.createElement("div")).className="hr";

  const epSel = document.createElement("div"); epSel.className="mini";
  for(let i=1;i<=12;i++){
    epSel.appendChild(mkSmall(`${i}è©±`,"", ()=>{
      state.k.bonus.epi += 1;
      state.k.bonus.epiLast = i;
      if(i===7) state.k.bonus.epi7 += 1;
      saveState(); addHist("k",`EP ${i}è©± +1`); renderAll();
    }));
  }
  epiField.appendChild(epSel);
  bTwo.appendChild(epiField);

  bBox.appendChild(bTwo);
  box.appendChild(bBox);

  // chars
  const cBox = document.createElement("div"); cBox.className="chip";
  cBox.innerHTML = `<h3>ã‚­ãƒ£ãƒ©ç´¹ä»‹ï¼ˆç”·å¥³ï¼‰</h3>`;
  const cTwo = document.createElement("div"); cTwo.className="two";

  const mkCounter = (label, getter, inc, dec) => {
    const f = document.createElement("div"); f.className="field";
    f.innerHTML = `<div class="label">${label}</div>`;
    const line = document.createElement("div"); line.className="tapline";
    line.appendChild(mkPill(`<span class="v">${getter()}</span>`));
    const btns = document.createElement("div"); btns.className="tapbtns";
    btns.appendChild(mkSmall("+1","good", ()=>{ inc(1); }));
    btns.appendChild(mkSmall("+10","good", ()=>{ inc(10); }));
    btns.appendChild(mkSmall("âˆ’1","bad", ()=>{ dec(1); }));
    line.appendChild(btns);
    f.appendChild(line);
    return f;
  };

  cTwo.appendChild(mkCounter("ç”·æ€§ã‚­ãƒ£ãƒ©", ()=>state.k.char.male,
    (n)=>{ state.k.char.male+=n; saveState(); addHist("k",`ç”·æ€§ +${n}`); renderAll(); },
    (n)=>{ state.k.char.male=Math.max(0,state.k.char.male-n); saveState(); addHist("k",`ç”·æ€§ âˆ’${n}`); renderAll(); }
  ));
  cTwo.appendChild(mkCounter("å¥³æ€§ã‚­ãƒ£ãƒ©", ()=>state.k.char.female,
    (n)=>{ state.k.char.female+=n; saveState(); addHist("k",`å¥³æ€§ +${n}`); renderAll(); },
    (n)=>{ state.k.char.female=Math.max(0,state.k.char.female-n); saveState(); addHist("k",`å¥³æ€§ âˆ’${n}`); renderAll(); }
  ));
  cBox.appendChild(cTwo);
  box.appendChild(cBox);

  const note = document.createElement("div");
  note.className="note";
  note.innerHTML = `â€» ã‚«ãƒãƒãƒªå´ã¯è§£æå€¤ãŒå°‘ãªã„ã®ã§â€œå‚è€ƒè¡¨ç¤ºâ€ä¸­å¿ƒï¼ˆã‚ãªãŸé‡è¦–ï¼šCZ/é§¿åŸã¯å¼·ã‚ã«è¦‹ã›ã‚‹ï¼‰`;
  box.appendChild(note);

  return box;
}

/* =========================
   RE2 Left (subtabs)
========================= */
function renderRE2Left(){
  const box = document.createElement("div");

  // Sub tabs
  const tabs = document.createElement("div");
  tabs.className="tinyTabs";
  const tInput = document.createElement("button");
  const tJudge = document.createElement("button");
  const tHist = document.createElement("button");
  tInput.textContent="å…¥åŠ›";
  tJudge.textContent="åˆ¤å®š";
  tHist.textContent="å½“æ—¥å±¥æ­´";

  const setSub = (k)=>{ state.r.subTab=k; saveState(); renderAll(); };
  tInput.onclick=()=>setSub("input");
  tJudge.onclick=()=>setSub("judge");
  tHist.onclick=()=>setSub("history");

  tInput.classList.toggle("active", state.r.subTab==="input");
  tJudge.classList.toggle("active", state.r.subTab==="judge");
  tHist.classList.toggle("active", state.r.subTab==="history");

  tabs.appendChild(tInput); tabs.appendChild(tJudge); tabs.appendChild(tHist);
  box.appendChild(tabs);

  if(state.r.subTab==="input"){
    box.appendChild(renderRE2Input());
  }else if(state.r.subTab==="judge"){
    box.appendChild(renderRE2Confirm());
  }else{
    box.appendChild(renderRE2DayHistory());
  }
  return box;
}

/* --- RE2 Input --- */
function renderRE2Input(){
  const root = document.createElement("div");

  // totalG (PCæ¥½)
  const tg = document.createElement("div"); tg.className="field";
  tg.innerHTML = `<div class="label">ç·ã‚²ãƒ¼ãƒ æ•°ï¼ˆPCã§ã‚‚ä¸€ç™ºå…¥åŠ›ï¼‰</div>`;
  const line = document.createElement("div"); line.className="tapline";
  const inp = document.createElement("input");
  inp.type="text";
  inp.id="totalGInput";
  inp.placeholder="ä¾‹ï¼š1200";
  inp.value = state.r.totalG;
  inp.onkeydown = (e)=>{ if(e.key==="Enter"){ applyTotalG(); } };
  line.appendChild(inp);
  line.appendChild(mkSmall("ç¢ºå®š","best", ()=>applyTotalG()));
  tg.appendChild(line);

  const btns = document.createElement("div"); btns.className="tapbtns"; btns.style.marginTop="6px";
  btns.appendChild(mkSmall("+500","good", ()=>addTotalG(500)));
  btns.appendChild(mkSmall("+1000","good", ()=>addTotalG(1000)));
  btns.appendChild(mkSmall("ã‚¯ãƒªã‚¢","bad", ()=>{ state.r.totalG=""; saveState(); addHist("r","ç·G ã‚¯ãƒªã‚¢"); renderAll(); }));
  tg.appendChild(btns);
  root.appendChild(tg);

  // CZ / AT
  const ca = document.createElement("div"); ca.className="chip";
  ca.innerHTML = `<h3>CZ / ATï¼ˆé€£å‹•ï¼†ä¿®æ­£ãŒå´©ã‚Œãªã„ï¼‰</h3>`;
  const two = document.createElement("div"); two.className="two";

  // CZ
  const cz = document.createElement("div"); cz.className="field";
  cz.innerHTML = `<div class="label">CZï¼ˆå›æ•° / æˆåŠŸï¼‰</div>`;
  const czLine = document.createElement("div"); czLine.className="tapline";
  czLine.appendChild(mkPill(`<span>CZ</span><span class="v">${state.r.cz.count}</span><span style="opacity:.6;">ï½œ</span><span>æˆåŠŸ</span><span class="v">${state.r.cz.win}</span>`));
  const czBtns = document.createElement("div"); czBtns.className="tapbtns";
  czBtns.appendChild(mkSmall("CZ +1","good", ()=>{
    state.r.cz.count += 1;
    saveState(); addHist("r","CZ +1"); renderAll();
  }));
  czBtns.appendChild(mkSmall("æˆåŠŸ +1ï¼ˆAT+1ï¼‰","best", ()=>{
    // CZæˆåŠŸï¼CZ+1 + æˆåŠŸ+1 + AT+1
    state.r.cz.count += 1;
    state.r.cz.win += 1;
    state.r.at.count += 1;
    saveState(); addHist("r","CZæˆåŠŸ +1 â†’ AT+1"); renderAll();
  }));
  czBtns.appendChild(mkSmall("CZ âˆ’1","bad", ()=>{
    state.r.cz.count = Math.max(0, state.r.cz.count-1);
    state.r.cz.win = Math.min(state.r.cz.win, state.r.cz.count);
    saveState(); addHist("r","CZ âˆ’1"); renderAll();
  }));
  czBtns.appendChild(mkSmall("æˆåŠŸ âˆ’1","bad", ()=>{
    state.r.cz.win = Math.max(0, state.r.cz.win-1);
    state.r.cz.count = Math.max(state.r.cz.count, state.r.cz.win);
    saveState(); addHist("r","CZæˆåŠŸ âˆ’1"); renderAll();
  }));
  czLine.appendChild(czBtns);
  cz.appendChild(czLine);

  const czFix = document.createElement("div");
  czFix.className="note";
  czFix.style.marginTop="6px";
  czFix.innerHTML = `â€» æˆåŠŸ+1ã¯ATã‚‚+1ã«è‡ªå‹•é€£å‹•ã€‚ä¿®æ­£ã¯ä¸‹ã®ATå´ã§ã€ŒATã ã‘ã€ã€ŒAT&æˆåŠŸã€ã©ã£ã¡ã§ã‚‚èª¿æ•´ã§ãã‚‹ã‚ˆã€‚`;
  cz.appendChild(czFix);

  // ATï¼ˆèª¤ã‚¿ãƒƒãƒ—é˜²æ­¢ï¼šATã¯ç›´æ¥+ã§ããªã„ï¼‰
  const at = document.createElement("div"); at.className="field";
  at.innerHTML = `<div class="label">ATï¼ˆè‡ªå‹•ã®ã¿ / ä¿®æ­£OKï¼‰</div>`;
  const atLine = document.createElement("div"); atLine.className="tapline";
  atLine.appendChild(mkPill(`<span>AT</span><span class="v">${state.r.at.count}</span>`));
  const atBtns = document.createElement("div"); atBtns.className="tapbtns";
  atBtns.appendChild(mkSmall("AT âˆ’1ï¼ˆATã®ã¿ï¼‰","bad", ()=>{
    state.r.at.count = Math.max(0, state.r.at.count-1);
    saveState(); addHist("r","AT âˆ’1ï¼ˆATã®ã¿ï¼‰"); renderAll();
  }));
  atBtns.appendChild(mkSmall("AT âˆ’1 & æˆåŠŸ âˆ’1","bad", ()=>{
    state.r.at.count = Math.max(0, state.r.at.count-1);
    state.r.cz.win = Math.max(0, state.r.cz.win-1);
    state.r.cz.count = Math.max(state.r.cz.count, state.r.cz.win);
    saveState(); addHist("r","AT âˆ’1 & æˆåŠŸ âˆ’1"); renderAll();
  }));
  atBtns.appendChild(mkSmall("æ‰‹å…¥åŠ›ã§ç›´ã™","warn", ()=>{
    const v = prompt("ATå›æ•°ã‚’æ•°å€¤ã§å…¥åŠ›ï¼ˆç¾åœ¨ï¼š"+state.r.at.count+"ï¼‰", String(state.r.at.count));
    if(v==null) return;
    state.r.at.count = Math.max(0, safeInt(v));
    // æ•´åˆæ€§ï¼šAT < æˆåŠŸ ã®å ´åˆã€æˆåŠŸã‚’ATã¾ã§è½ã¨ã™ã‹ï¼Ÿã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å§”ã­ã‚‹ã¨äº‹æ•…ã‚‹ã®ã§è‡ªå‹•ã§åˆã‚ã›ã‚‹
    if(state.r.at.count < state.r.cz.win){
      state.r.cz.win = state.r.at.count;
      state.r.cz.count = Math.max(state.r.cz.count, state.r.cz.win);
    }
    saveState(); addHist("r","AT æ‰‹å…¥åŠ›ä¿®æ­£"); renderAll();
  }));
  atLine.appendChild(atBtns);
  at.appendChild(atLine);

  two.appendChild(cz);
  two.appendChild(at);
  ca.appendChild(two);
  root.appendChild(ca);

  // ATé–‹å§‹ã‚¹ãƒ†ãƒ¼ã‚¸
  const st = document.createElement("div"); st.className="chip";
  st.innerHTML = `<h3>ATé–‹å§‹ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆATãƒ¬ãƒ™ãƒ«ã®ãƒ’ãƒ³ãƒˆï¼‰</h3>`;
  const stTwo = document.createElement("div"); stTwo.className="two";

  const mkStage = (label, key) => {
    const f = document.createElement("div"); f.className="field";
    f.innerHTML = `<div class="label">${label}</div>`;
    const line = document.createElement("div"); line.className="tapline";
    line.appendChild(mkPill(`<span class="v">${state.r.atStart[key]}</span>`));
    const btns = document.createElement("div"); btns.className="tapbtns";
    btns.appendChild(mkSmall("+1","good", ()=>{ state.r.atStart[key]++; saveState(); addHist("r",`ATé–‹å§‹ ${label} +1`); renderAll(); }));
    btns.appendChild(mkSmall("âˆ’1","bad", ()=>{ state.r.atStart[key]=Math.max(0,state.r.atStart[key]-1); saveState(); addHist("r",`ATé–‹å§‹ ${label} âˆ’1`); renderAll(); }));
    line.appendChild(btns);
    f.appendChild(line);
    return f;
  };
  stTwo.appendChild(mkStage("è­¦å¯Ÿç½²ï¼ˆå…¨ãƒ¬ãƒ™ãƒ«å¯èƒ½ï¼‰","police"));
  stTwo.appendChild(mkStage("ä¸‹æ°´é“ï¼ˆLv2ä»¥ä¸Šã®æœŸå¾…ï¼‰","sewer"));
  stTwo.appendChild(mkStage("ç ”ç©¶æ‰€ï¼ˆLv3ä»¥ä¸Šï¼‰","lab"));
  stTwo.appendChild(mkStage("è„±å‡ºè·¯ï¼ˆLv3/4ï¼‰","escape"));
  st.appendChild(stTwo);
  st.appendChild(document.createElement("div")).className="hr";
  const stNote = document.createElement("div");
  stNote.className="note";
  stNote.textContent = "â€» ç ”ç©¶æ‰€/è„±å‡ºè·¯ã¯è¨­å®šå·®è‡ªä½“ã¯è–„ã„ã‘ã©ã€è¨˜éŒ²ã¨ã—ã¦çŸ›ç›¾ã—ãªã„ã‚ˆã†ã«æ®‹ã›ã‚‹ã‚ˆã†ã«ã—ã¦ã‚‹ã‚ˆã€‚";
  st.appendChild(stNote);
  root.appendChild(st);

  // ãƒªãƒ—ãƒ¬ã‚¤â†’CZï¼ˆå¿ƒéŸ³ï¼‰
  const rp = document.createElement("div"); rp.className="chip";
  rp.innerHTML = `<h3>ãƒªãƒ—ãƒ¬ã‚¤çµŒç”±ã®CZï¼ˆå¿ƒéŸ³åˆ¥ï¼‰</h3>`;
  const rpTwo = document.createElement("div"); rpTwo.className="two";
  const mkRep = (label, key) => {
    const f = document.createElement("div"); f.className="field";
    f.innerHTML = `<div class="label">${label}</div>`;
    const line = document.createElement("div"); line.className="tapline";
    line.appendChild(mkPill(`<span class="v">${state.r.repCZ[key]}</span>`));
    const btns = document.createElement("div"); btns.className="tapbtns";
    btns.appendChild(mkSmall("+1","good", ()=>{ state.r.repCZ[key]++; saveState(); addHist("r",`ãƒªãƒ—â†’CZ ${label} +1`); renderAll(); }));
    btns.appendChild(mkSmall("âˆ’1","bad", ()=>{ state.r.repCZ[key]=Math.max(0,state.r.repCZ[key]-1); saveState(); addHist("r",`ãƒªãƒ—â†’CZ ${label} âˆ’1`); renderAll(); }));
    line.appendChild(btns);
    f.appendChild(line);
    return f;
  };
  rpTwo.appendChild(mkRep("å¿ƒéŸ³ï¼šé’ï¼ˆå·®ãŒå¤§ãã„ï¼‰","blue"));
  rpTwo.appendChild(mkRep("å¿ƒéŸ³ï¼šç·‘ï¼ˆå·®ãŒå¤§ãã„ï¼‰","green"));
  rpTwo.appendChild(mkRep("å¿ƒéŸ³ï¼šèµ¤ï¼ˆç¾å®Ÿçš„ï¼‰","red"));
  rpTwo.appendChild(mkRep("å¿ƒéŸ³ï¼šç´«ï¼ˆåŠ ç‚¹å¼±ã‚ï¼‰","purple"));
  rp.appendChild(rpTwo);
  rp.appendChild(document.createElement("div")).className="hr";
  const rpNote = document.createElement("div");
  rpNote.className="note";
  rpNote.textContent = "â€» ç´«ã¯ã©ã®è¨­å®šã§ã‚‚é€šã‚Šã‚„ã™ã„ã®ã§åŠ ç‚¹ã¯æ§ãˆã‚ã€‚é’/ç·‘ã‚’å¼·ã‚ã«è©•ä¾¡ã€‚";
  rp.appendChild(rpNote);
  root.appendChild(rp);

  // ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆCZ
  const ty = document.createElement("div"); ty.className="chip";
  ty.innerHTML = `<h3>ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆï¼ˆç›®ã«è¦‹ãˆã‚‹ç¢ºå®šï¼šCZçªå…¥å›æ•°ï¼‰</h3>`;
  const tyF = document.createElement("div"); tyF.className="field";
  tyF.innerHTML = `<div class="label">ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆCZçªå…¥</div>`;
  const tyLine = document.createElement("div"); tyLine.className="tapline";
  tyLine.appendChild(mkPill(`<span class="v">${state.r.tyrant.cz}</span>`));
  const tyBtns = document.createElement("div"); tyBtns.className="tapbtns";
  tyBtns.appendChild(mkSmall("+1","good", ()=>{ state.r.tyrant.cz++; saveState(); addHist("r","ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆCZ +1ï¼ˆé«˜ç¢ºå¯„ã‚Šï¼‰"); renderAll(); }));
  tyBtns.appendChild(mkSmall("âˆ’1","bad", ()=>{ state.r.tyrant.cz=Math.max(0,state.r.tyrant.cz-1); saveState(); addHist("r","ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆCZ âˆ’1"); renderAll(); }));
  tyLine.appendChild(tyBtns);
  tyF.appendChild(tyLine);
  ty.appendChild(tyF);
  ty.appendChild(document.createElement("div")).className="hr";
  const tyNote = document.createElement("div");
  tyNote.className="note";
  tyNote.textContent = "â€» è¶³éŸ³åŒºé–“ã‚’ç´°ã‹ãæ•°ãˆã‚‹æ–¹å¼ã¯ä»Šå›ã¯å…¥ã‚Œãšã€å®Ÿæˆ¦ã§ç¢ºå®Ÿãªâ€œçªå…¥â€ã ã‘æ¡ç”¨ã€‚è¶³éŸ³è©•ä¾¡ã¯å¾Œã‹ã‚‰è¿½åŠ ã‚‚ã§ãã‚‹ã‚ˆã€‚";
  ty.appendChild(tyNote);
  root.appendChild(ty);

  // ATç›´æ’ƒï¼ˆå¥‘æ©Ÿåˆ¥ï¼‰
  const dj = document.createElement("div"); dj.className="chip";
  dj.innerHTML = `<h3>ATç›´æ’ƒï¼ˆå¥‘æ©Ÿåˆ¥ï¼‰</h3>`;
  const djTwo = document.createElement("div"); djTwo.className="two";
  const mkD = (label, key) => {
    const f = document.createElement("div"); f.className="field";
    f.innerHTML = `<div class="label">${label}</div>`;
    const line = document.createElement("div"); line.className="tapline";
    line.appendChild(mkPill(`<span class="v">${state.r.direct[key]}</span>`));
    const btns = document.createElement("div"); btns.className="tapbtns";
    btns.appendChild(mkSmall("+1","good", ()=>{ state.r.direct[key]++; saveState(); addHist("r",`ATç›´æ’ƒ ${label} +1`); renderAll(); }));
    btns.appendChild(mkSmall("âˆ’1","bad", ()=>{ state.r.direct[key]=Math.max(0,state.r.direct[key]-1); saveState(); addHist("r",`ATç›´æ’ƒ ${label} âˆ’1`); renderAll(); }));
    line.appendChild(btns);
    f.appendChild(line);
    return f;
  };
  djTwo.appendChild(mkD("ãƒªãƒ—ãƒ¬ã‚¤å¥‘æ©Ÿ","replay"));
  djTwo.appendChild(mkD("å¼±ãƒ¬ã‚¢å½¹å¥‘æ©Ÿ","weak"));
  djTwo.appendChild(mkD("å¼·ãƒ¬ã‚¢å½¹å¥‘æ©Ÿ","strong"));
  dj.appendChild(djTwo);
  dj.appendChild(document.createElement("div")).className="hr";
  const djNote = document.createElement("div");
  djNote.className="note";
  djNote.textContent = "â€» ç›´æ’ƒã¯å¼·ã„è£œåŠ©ã ã‘ã©ã€1å›ã§å…¨éƒ¨ãŒ6ã«ãªã‚‹ã‚ˆã†ãªæš´èµ°ã¯ã•ã›ãªã„èª¿æ•´ã«ã—ã¦ã‚‹ã‚ˆã€‚";
  dj.appendChild(djNote);
  root.appendChild(dj);

  // Figures (input)
  const f = document.createElement("div"); f.className="chip";
  f.innerHTML = `<h3>ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ï¼ˆå…¥åŠ›ç”¨ï¼šå…¨è¡¨ç¤ºï¼‰</h3>`;
  const meta = state.r.figs._meta;
  for(const item of meta){
    const field = document.createElement("div");
    field.className="field";
    field.innerHTML = `<div class="label">${item.group}ï½œ${item.tag}</div>`;
    const line = document.createElement("div"); line.className="tapline";
    line.appendChild(mkPill(`<span>${item.name}</span><span class="v">${state.r.figs[item.key]}</span>`));
    const btns = document.createElement("div"); btns.className="tapbtns";
    btns.appendChild(mkSmall("+1","good", ()=>{
      state.r.figs[item.key] += 1;
      saveState();
      addHist("r", `ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ï¼š${item.name} +1ï¼ˆ${item.tag}ï¼‰`);
      renderAll();
    }));
    btns.appendChild(mkSmall("âˆ’1","bad", ()=>{
      state.r.figs[item.key] = Math.max(0, state.r.figs[item.key]-1);
      saveState();
      addHist("r", `ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ï¼š${item.name} âˆ’1`);
      renderAll();
    }));
    line.appendChild(btns);
    field.appendChild(line);
    f.appendChild(field);
  }
  f.appendChild(document.createElement("div")).className="hr";
  const fNote = document.createElement("div");
  fNote.className="note";
  fNote.textContent = "â€» åˆ¤å®šã§ã¯ã€Œå¦å®šç³»ã¯é™¤å¤–ï¼ˆå¼·ï¼‰ã€ã€å¥‡å¶ã¯ä¸Šé™ä»˜ãã§ç©ã¿ä¸Šã’ã€4/5/6ç¤ºå”†ã¯ç©ã¿ä¸Šã’æ–¹å¼ã€‚";
  f.appendChild(fNote);
  root.appendChild(f);

  return root;
}

/* --- RE2 Confirmï¼ˆ0éè¡¨ç¤ºï¼†å¤šã„é †ï¼†ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ï¼‰ --- */
function renderRE2Confirm(){
  const root = document.createElement("div");

  // Quick summary + percentages
  const res = judgeRE2Full();

  const rankDiv = document.createElement("div");
  rankDiv.className = "rank";
  const badge = document.createElement("div");
  badge.className = "badge " + (
    res.band==="low" ? "b-red" :
    res.band==="mid" ? "b-yellow" :
    res.band==="high" ? "b-green" : "b-purple"
  );
  badge.textContent = res.headline;
  rankDiv.appendChild(badge);

  const info = document.createElement("div");
  info.className="sub";
  info.textContent = "åºç›¤(ã€œ1000G)ã¯æŒ™å‹•é‡è¦–ï¼ä¸­ç›¤ä»¥é™ã¯å…¨è¦ç´ ã§ãƒãƒ©ãƒ³ã‚¹è©•ä¾¡ï¼ˆç¢ºå®šãƒ»å¦å®šã¯æœ€å„ªå…ˆï¼‰";
  rankDiv.appendChild(info);
  root.appendChild(rankDiv);

  // % list (top3 colored)
  const pctBox = document.createElement("div");
  pctBox.className="chip";
  pctBox.innerHTML = `<h3>è¨­å®šæœŸå¾…åº¦ï¼ˆï¼…ï¼‰</h3>`;
  const list = document.createElement("div");

  res.sorted.forEach((it, idx)=>{
    const row = document.createElement("div");
    row.className="krow";
    const left = document.createElement("div");
    left.className="left";
    const right = document.createElement("div");
    right.className="right";
    left.textContent = `è¨­å®š${it.s}`;
    right.textContent = `${it.p.toFixed(1)}%`;

    if(idx===0) { left.classList.add("b-purple"); right.classList.add("b-purple"); }
    else if(idx===1) { left.classList.add("b-green"); right.classList.add("b-green"); }
    else if(idx===2) { left.classList.add("b-yellow"); right.classList.add("b-yellow"); }
    else { left.style.opacity=".75"; right.style.opacity=".75"; }

    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  });

  if(res.sorted.length===0){
    const n = document.createElement("div");
    n.className="note";
    n.textContent="å¦å®š/ç¢ºå®šã®çµ„ã¿åˆã‚ã›ã§å€™è£œãŒæ¶ˆãˆã™ãã¦ã„ã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚å…¥åŠ›ã‚’ç¢ºèªã—ã¦ã­ã€‚";
    pctBox.appendChild(n);
  }else{
    pctBox.appendChild(list);
  }

  const n2 = document.createElement("div");
  n2.className="note";
  n2.style.marginTop="8px";
  n2.textContent = res.comment;
  pctBox.appendChild(n2);
  root.appendChild(pctBox);

  // figure confirm (0 hidden, grouped, sorted)
  const figBox = document.createElement("div");
  figBox.className="chip";
  figBox.innerHTML = `<h3>ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ç¢ºèªï¼ˆ0éè¡¨ç¤ºï¼å¤šã„é †ï¼ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ï¼‰</h3>`;

  const meta = state.r.figs._meta;
  const counts = meta
    .map(m=>({ ...m, v: Number(state.r.figs[m.key]||0) }))
    .filter(x=>x.v>0);

  if(counts.length===0){
    const p = document.createElement("div");
    p.className="note";
    p.textContent="ã¾ã ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã®å…¥åŠ›ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    figBox.appendChild(p);
  }else{
    const groups = {};
    for(const c of counts){
      if(!groups[c.group]) groups[c.group]=[];
      groups[c.group].push(c);
    }
    for(const g of Object.keys(groups)){
      groups[g].sort((a,b)=>b.v-a.v);
      const h = document.createElement("div");
      h.className="note";
      h.style.margin="6px 0";
      h.textContent = `â–  ${g}`;
      figBox.appendChild(h);

      for(const item of groups[g]){
        const row = document.createElement("div");
        row.className="krow";
        const l = document.createElement("div"); l.className="left";
        const r = document.createElement("div"); r.className="right";
        l.textContent = `${item.name}ï¼ˆ${item.tag}ï¼‰`;
        r.textContent = `${item.v}å›`;
        row.appendChild(l); row.appendChild(r);
        figBox.appendChild(row);
      }
    }
  }
  root.appendChild(figBox);

  // reasons
  const reason = document.createElement("div");
  reason.className="chip";
  reason.innerHTML = `<h3>åˆ¤å®šç†ç”±ï¼ˆè¦ç‚¹ï¼‰</h3>`;
  const ul = document.createElement("ul");
  for(const r of res.reasons){
    const li = document.createElement("li");
    li.textContent = r;
    ul.appendChild(li);
  }
  reason.appendChild(ul);
  root.appendChild(reason);

  return root;
}

/* --- RE2 Day history (today full) --- */
function renderRE2DayHistory(){
  const root = document.createElement("div");
  const box = document.createElement("div");
  box.className="chip";
  box.innerHTML = `<h3>å½“æ—¥å±¥æ­´ï¼ˆRE2ã®ã¿ï¼šå…¨ä»¶ï¼‰</h3>`;

  const list = document.createElement("div");
  const todays = state.history.filter(x=>x.day===todayStr && x.tab==="r");
  if(todays.length===0){
    const p = document.createElement("div");
    p.className="note";
    p.textContent="å½“æ—¥ã®RE2å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    list.appendChild(p);
  }else{
    for(const it of todays){
      const div = document.createElement("div");
      div.className="hist item";
      // reuse style lightly
      const outer = document.createElement("div");
      outer.className="item";
      const left = document.createElement("div");
      left.className="t";
      left.textContent = it.text;
      const right = document.createElement("div");
      right.className="d";
      right.innerHTML = `${it.ts} <button class="x" type="button">å‰Šé™¤</button>`;
      right.querySelector("button").onclick = ()=>delHist(it.id);
      outer.appendChild(left); outer.appendChild(right);
      list.appendChild(outer);
    }
  }
  box.appendChild(list);
  root.appendChild(box);
  return root;
}

/* =========================
   RE2 Judge (full)
========================= */
function judgeRE2Full(){
  const r = state.r;
  const g = safeInt(r.totalG || 0);
  const early = (g>0 && g<=1000);

  // base scores
  const score = {1:0,2:0,3:0,4:0,5:0,6:0};
  const excluded = new Set();

  const figs = r.figs;

  // hard confirms
  if((figs.eq6||0) > 0){
    return {
      band:"ultra",
      headline:"ğŸŸ£ è¨­å®š6 æ¿ƒåšï¼ˆç¢ºå®šç³»ï¼‰",
      sorted: [{s:6,p:100}],
      reasons:[`ã‚¨ãƒ³ã‚¿ãƒ©ã‚¤ã‚ªãƒ³ï¼ˆè¨­å®š6ç¢ºå®šï¼‰ã‚’ç¢ºèªï¼š${figs.eq6}å›`],
      comment:"ç¢ºå®šãŒå‡ºã¦ã‚‹æ—¥ã¯ãƒ–ãƒ¬ãªã„ã‚ˆã€‚è½ã¡ç€ã„ã¦æœŸå¾…å€¤æ‹¾ã„ã«ã„ã“ã€‚",
    };
  }

  // denies => exclude that setting (å¼·)
  if((figs.deny1||0)>0) excluded.add(1);
  if((figs.deny2||0)>0) excluded.add(2);
  if((figs.deny3||0)>0) excluded.add(3);
  if((figs.deny4||0)>0) excluded.add(4);

  // floors (3+/4+/5+)
  const ge3 = figs.ge3||0, ge4 = figs.ge4||0, ge5 = figs.ge5||0;
  if(ge3>0){ score[3]+=8; score[4]+=8; score[5]+=8; score[6]+=8; }
  if(ge4>0){ score[4]+=10; score[5]+=10; score[6]+=10; }
  if(ge5>0){ score[5]+=14; score[6]+=14; }

  // parity points (cap)
  const capOdd = 20, capEven = 20;
  const oddPts = clamp((figs.oddWeak||0)*1 + (figs.oddStrong||0)*2, 0, capOdd);
  const evenPts = clamp((figs.evenWeak||0)*1 + (figs.evenStrong||0)*2, 0, capEven);

  // distribute parity
  for(const s of [1,3,5]) score[s] += oddPts;
  for(const s of [2,4,6]) score[s] += evenPts;

  // high setting hints (4/5/6) â€” no hard cap (but gentle)
  const hiPts = (figs.hiWeak||0)*1 + (figs.hiStrong||0)*2;
  score[4] += hiPts; score[5] += hiPts; score[6] += hiPts;

  // behavior weights
  const w = early ? 1.35 : 1.0; // åºç›¤ã¯æŒ™å‹•ã‚’å¼·ã‚ã‚‹

  // replay->CZ: blue/green strong, red medium, purple small
  const repBlue = r.repCZ.blue||0, repGreen=r.repCZ.green||0, repRed=r.repCZ.red||0, repPurple=r.repCZ.purple||0;
  const repPts = (repBlue*3 + repGreen*3 + repRed*2 + repPurple*0.8) * w;

  // add mostly to 4-6, but small to all to avoid â€œä¸€ç™ºã§6â€
  score[1] += repPts*0.10;
  score[2] += repPts*0.12;
  score[3] += repPts*0.14;
  score[4] += repPts*0.22;
  score[5] += repPts*0.22;
  score[6] += repPts*0.20;

  // tyrant CZ: add to high
  const tyr = (r.tyrant.cz||0) * w;
  score[1]+=tyr*0.2; score[2]+=tyr*0.25; score[3]+=tyr*0.35;
  score[4]+=tyr*0.7; score[5]+=tyr*0.8; score[6]+=tyr*0.8;

  // direct AT: contract based but â€œå¼·ã‚ã®è£œåŠ©â€
  const dReplay=r.direct.replay||0, dWeak=r.direct.weak||0, dStrong=r.direct.strong||0;
  const dPts = (dReplay*10 + dWeak*6 + dStrong*4) * w;

  score[1]+=dPts*0.10; score[2]+=dPts*0.12; score[3]+=dPts*0.16;
  score[4]+=dPts*0.30; score[5]+=dPts*0.32; score[6]+=dPts*0.30;

  // AT level stage distribution hint (soft)
  const police=r.atStart.police||0, sewer=r.atStart.sewer||0, lab=r.atStart.lab||0, escape=r.atStart.escape||0;
  const totalStage = police+sewer+lab+escape;
  if(totalStage>=3){
    const lv2plusHint = (sewer + lab + escape) / totalStage; // police is unknown
    // higher settings slightly better
    score[1] += lv2plusHint*2*w;
    score[2] += lv2plusHint*2.4*w;
    score[3] += lv2plusHint*3.2*w;
    score[4] += lv2plusHint*4.5*w;
    score[5] += lv2plusHint*5.0*w;
    score[6] += lv2plusHint*5.2*w;
  }

  // consistency: if excluded all? keep empty
  const candidates = [1,2,3,4,5,6].filter(s=>!excluded.has(s));
  if(candidates.length===0){
    return {
      band:"mid",
      headline:"ğŸŸ¡ å€™è£œãŒæ¶ˆãˆã™ãï¼ˆå…¥åŠ›è¦‹ç›´ã—ï¼‰",
      sorted: [],
      reasons:["å¦å®šç³»ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã®å…¥åŠ›ã§å€™è£œãŒå…¨æ¶ˆã—ã«ãªã£ã¦ã¾ã™ã€‚èª¤å…¥åŠ›ã®å¯èƒ½æ€§ãŒé«˜ã„ã‚ˆã€‚"],
      comment:"è½ã¡ç€ã„ã¦ãƒ•ã‚£ã‚®ãƒ¥ã‚¢å…¥åŠ›ã‚’è¦‹ç›´ã—ã¦ã­ã€‚"
    };
  }

  // convert to percentages with softmax-like
  const vals = candidates.map(s=>({s, v: score[s]}));
  const maxV = Math.max(...vals.map(x=>x.v));
  const exps = vals.map(x=>({s:x.s, e: Math.exp((x.v - maxV)/6)})); // temperature
  const sumE = exps.reduce((a,b)=>a+b.e,0);
  const sorted = exps
    .map(x=>({s:x.s, p: (x.e/sumE)*100}))
    .sort((a,b)=>b.p-a.p);

  // band/headline
  const top = sorted[0];
  const second = sorted[1];
  let band="mid";
  let headline="ğŸŸ¡ ä¸­é–“ã®å¯èƒ½æ€§";
  if(top && top.p>=55 && (second==null || top.p-second.p>=20)){ band="high"; headline="ğŸŸ¢ ä¸Šå¯„ã‚Šï¼ˆæ ¹æ‹ ãŒå¢—ãˆã¦ããŸï¼‰"; }
  if(top && top.p>=70){ band="ultra"; headline="ğŸŸ£ ã‹ãªã‚Šä¸Šã®æœŸå¾…ï¼ˆç¢ºä¿¡å¯„ã‚Šï¼‰"; }
  if(top && top.p<=35){ band="low"; headline="ğŸ”´ ä½ã€œä¸­ã®å¯èƒ½æ€§ï¼ˆæ…é‡ï¼‰"; }

  // reasons
  const reasons = [];
  if(early) reasons.push("ã€œ1000Gï¼šæŒ™å‹•ï¼ˆç›´æ’ƒ/ãƒªãƒ—CZ/ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆï¼‰ã‚’å¼·ã‚ã«è©•ä¾¡ä¸­");
  if((figs.deny1||0)>0) reasons.push(`è¨­å®š1å¦å®šï¼š${figs.deny1}å›`);
  if((figs.deny2||0)>0) reasons.push(`è¨­å®š2å¦å®šï¼š${figs.deny2}å›`);
  if((figs.deny3||0)>0) reasons.push(`è¨­å®š3å¦å®šï¼š${figs.deny3}å›`);
  if((figs.deny4||0)>0) reasons.push(`è¨­å®š4å¦å®šï¼š${figs.deny4}å›`);

  if(ge5>0) reasons.push(`è¨­å®š5ä»¥ä¸Šï¼š${ge5}å›`);
  if(ge4>0) reasons.push(`è¨­å®š4ä»¥ä¸Šï¼š${ge4}å›`);
  if(ge3>0) reasons.push(`è¨­å®š3ä»¥ä¸Šï¼š${ge3}å›`);

  const czRate = (r.cz.count>0) ? (r.cz.win/r.cz.count)*100 : null;
  reasons.push(`CZï¼š${r.cz.count}å›ï¼ˆæˆåŠŸ ${r.cz.win}ï¼‰ æˆåŠŸç‡ ${fmtPct(czRate)}`);
  reasons.push(`ATï¼š${r.at.count}å›ï¼ˆæˆåŠŸ+1ã§è‡ªå‹•åŠ ç®—ï¼‰`);
  const dTotal = dReplay+dWeak+dStrong;
  if(dTotal>0) reasons.push(`ATç›´æ’ƒï¼šåˆè¨ˆ${dTotal}ï¼ˆãƒªãƒ—${dReplay}/å¼±${dWeak}/å¼·${dStrong}ï¼‰`);
  const repTotal = repBlue+repGreen+repRed+repPurple;
  if(repTotal>0) reasons.push(`ãƒªãƒ—â†’CZï¼šåˆè¨ˆ${repTotal}ï¼ˆé’${repBlue}/ç·‘${repGreen}/èµ¤${repRed}/ç´«${repPurple}ï¼‰`);
  if((r.tyrant.cz||0)>0) reasons.push(`ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆCZï¼š${r.tyrant.cz}å›ï¼ˆé«˜ç¢ºå¯„ã‚Šã®ç¢ºå®šè¦ç´ ï¼‰`);
  if(totalStage>0) reasons.push(`ATé–‹å§‹ï¼šè­¦å¯Ÿç½²${police}/ä¸‹æ°´é“${sewer}/ç ”ç©¶æ‰€${lab}/è„±å‡ºè·¯${escape}`);

  // comment
  let comment = "";
  if(early){
    comment = "åºç›¤ã¯â€œæŒ™å‹•ã®å¼·ã•â€ãŒå‘½ã€‚ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ãŒã¾ã å¼±ãã¦ã‚‚ã€æŒ™å‹•ãŒè‰¯ã„ãªã‚‰ç„¦ã£ã¦åˆ‡ã‚‰ãªãã¦å¤§ä¸ˆå¤«ã ã‚ˆã€‚";
  }else{
    comment = "ä¸­ç›¤ä»¥é™ã¯â€œç¢ºå®šãƒ»å¦å®šâ†’æŒ™å‹•â†’ãƒ•ã‚£ã‚®ãƒ¥ã‚¢æ¯”ç‡â€ã®é †ã§å®‰å®šã€‚æ ¹æ‹ ãŒç©ã¿ä¸ŠãŒã£ã¦ã‚‹ã‹ã‚’è¦‹ã‚ˆã†ã€‚";
  }

  return {
    band, headline, sorted,
    reasons,
    comment
  };
}

function applyTotalG(){
  const el = document.getElementById("totalGInput");
  if(!el) return;
  state.r.totalG = String(el.value).replace(/[^\d]/g,"");
  saveState();
  addHist("r", `ç·G ç¢ºå®šï¼š${state.r.totalG||0}`);
  renderAll();
}
function addTotalG(n){
  const cur = safeInt(state.r.totalG||0);
  state.r.totalG = String(cur + n);
  saveState();
  addHist("r", `ç·G +${n} â†’ ${state.r.totalG}`);
  renderAll();
}

/* =========================
   Render Right (main card)
========================= */
function renderRight(){
  const judgeBox = document.getElementById("judgeBox");
  judgeBox.innerHTML = "";

  // Main right: show current tab quick headline only
  if(state.activeTab==="k"){
    const div = document.createElement("div"); div.className="rank";
    const b = document.createElement("div"); b.className="badge b-yellow";
    b.textContent="ã‚«ãƒãƒãƒªï¼šå‚è€ƒåˆ¤å®šï¼ˆç°¡æ˜“ï¼‰";
    div.appendChild(b);
    const info = document.createElement("div"); info.className="sub";
    info.textContent="ã‚«ãƒãƒãƒªã¯è§£æå€¤ãŒé™ã‚‰ã‚Œã‚‹ãŸã‚ã€è¨˜éŒ²ã¨å‚¾å‘ä¸­å¿ƒã€‚";
    div.appendChild(info);
    judgeBox.appendChild(div);
  }else{
    const res = judgeRE2Full();
    const div = document.createElement("div"); div.className="rank";
    const b = document.createElement("div");
    b.className = "badge " + (res.band==="low"?"b-red":res.band==="mid"?"b-yellow":res.band==="high"?"b-green":"b-purple");
    b.textContent = res.headline;
    div.appendChild(b);
    const info = document.createElement("div"); info.className="sub";
    info.textContent="RE2ï¼šè¨­å®š1ã€œ6ã®ï¼…ã¯å·¦ã®ã€Œåˆ¤å®šã€ã‚¿ãƒ–ã§ä¸Šä½3è‰²è¡¨ç¤ºã€‚";
    div.appendChild(info);
    judgeBox.appendChild(div);
  }

  // History list (today, last10)
  const hist = document.getElementById("hist");
  hist.innerHTML = "";
  const todays = state.history.filter(x=>x.day===todayStr);
  const show = todays.slice(0,10);
  if(show.length===0){
    const p = document.createElement("div");
    p.className="note";
    p.textContent = "ã¾ã å½“æ—¥å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã®ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¨˜éŒ²ã—ã¦ã­ã€‚";
    hist.appendChild(p);
  }else{
    for(const it of show){
      const div = document.createElement("div");
      div.className="item";
      const left = document.createElement("div");
      left.className="t";
      left.textContent = (it.tab==="k"?"[ã‚«ãƒãƒãƒª] ":"[RE2] ") + it.text;
      const right = document.createElement("div");
      right.className="d";
      right.innerHTML = `${it.ts} <button class="x" type="button">å‰Šé™¤</button>`;
      right.querySelector("button").onclick = ()=>delHist(it.id);
      div.appendChild(left);
      div.appendChild(right);
      hist.appendChild(div);
    }
  }
}

/* =========================
   Buttons: reset / export / import
========================= */
document.getElementById("btnResetDay").addEventListener("click", ()=>{
  if(confirm("å½“æ—¥ã®å…¥åŠ›ã¨å½“æ—¥å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ")){
    resetDay();
  }
});
document.getElementById("btnExport").addEventListener("click", ()=>{
  const payload = { exported_at: new Date().toISOString(), app: "kabare2_v2_re2full", state };
  downloadJSON(payload, `kabare2_${todayStr}.json`);
});
document.getElementById("btnImport").addEventListener("click", ()=>{
  document.getElementById("fileIn").click();
});
document.getElementById("fileIn").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const obj = JSON.parse(txt);
    if(!obj || !obj.state) throw new Error("invalid");
    state = obj.state;
    if(state.day !== todayStr){
      state.day = todayStr;
      state.k = defaultKState();
      state.r = defaultRState();
    }
    if(!state.r?.figs?._meta){
      const fixed = initRE2Figs();
      if(state.r?.figs){
        for(const k of Object.keys(fixed)){
          if(k==="_meta") continue;
          fixed[k] = Number(state.r.figs[k]||0);
        }
      }
      state.r.figs = fixed;
    }
    if(!state.r.subTab) state.r.subTab="input";
    saveState();
    renderAll();
    alert("èª­ã¿è¾¼ã¿å®Œäº†ï¼");
  }catch(err){
    alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ã­ã€‚");
  }finally{
    e.target.value = "";
  }
});

/* =========================
   Init
========================= */
renderAll();
</script>
</body>
</html>
