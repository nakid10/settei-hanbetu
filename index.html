<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ã‚«ãƒãƒãƒª & RE2 åˆ¤å®šãƒ„ãƒ¼ãƒ«ï¼ˆã‚¿ãƒƒãƒ—å…¥åŠ›ï¼‰</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111826; --panel2:#0f1622; --text:#e8eef7; --muted:#a7b3c7;
      --line:#243247; --btn:#1a2435; --btn2:#182033; --good:#26d07c; --warn:#ffcc66; --bad:#ff5d5d; --best:#b98cff;
      --chip:#162033;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Hiragino Sans", "Noto Sans JP", Arial, sans-serif;
      background:linear-gradient(180deg, #070b10 0%, var(--bg) 70%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,15,20,.86); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .title{ font-weight:700; font-size:14px; letter-spacing:.2px; }
    .sub{ font-size:12px; color:var(--muted); }
    .wrap{ padding:12px; max-width:1100px; margin:0 auto; }
    .grid{
      display:grid; gap:12px;
      grid-template-columns: 1.1fr .9fr;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns:1fr; }
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0; padding:12px 12px 10px;
      font-size:14px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .body{ padding:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1 1 auto; }
    .field{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      min-width: 160px;
    }
    .label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="number"], input[type="text"], select{
      width:100%;
      background:rgba(255,255,255,.04);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      font-size:14px;
      outline:none;
    }
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .seg button{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:.12s;
      flex: 1 1 auto;
      min-width: 120px;
    }
    .seg button:hover{ transform: translateY(-1px); }
    .seg button.active{
      border-color: rgba(185,140,255,.8);
      box-shadow: 0 0 0 3px rgba(185,140,255,.12);
    }
    .mini{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.2);
      font-size:13px;
      color:var(--text);
      user-select:none;
    }
    .pill .v{ font-weight:700; }
    .tapline{
      display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .tapbtns{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .btn{
      background:var(--btn2);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:.12s;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.good{ border-color: rgba(38,208,124,.5); }
    .btn.bad{ border-color: rgba(255,93,93,.5); }
    .btn.warn{ border-color: rgba(255,204,102,.55); }
    .btn.best{ border-color: rgba(185,140,255,.6); }
    .btn.small{ padding:8px 10px; font-size:12px; border-radius:10px; }
    .chip{
      background:var(--chip);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      margin-top:10px;
    }
    .chip h3{ margin:0 0 8px; font-size:13px; color:var(--muted); font-weight:600; }
    .rank{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.2);
      margin-bottom:10px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:.2px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .b-red{ color:var(--bad); border-color:rgba(255,93,93,.45); }
    .b-yellow{ color:var(--warn); border-color:rgba(255,204,102,.45); }
    .b-green{ color:var(--good); border-color:rgba(38,208,124,.45); }
    .b-purple{ color:var(--best); border-color:rgba(185,140,255,.55); }
    .reason{
      font-size:13px; color:var(--text);
      line-height:1.5;
      margin:8px 0 0;
    }
    .reason ul{ margin:8px 0 0 18px; color:var(--muted); }
    .hr{ height:1px; background:var(--line); margin:10px 0; }
    .hist{
      max-height: 360px;
      overflow:auto;
      padding-right:6px;
    }
    .hist .item{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
      font-size:12px;
    }
    .hist .item .t{ color:var(--text); line-height:1.35; }
    .hist .item .d{ color:var(--muted); font-size:11px; white-space:nowrap; }
    .hist .item .x{
      background:transparent; border:1px solid rgba(255,93,93,.4);
      color:var(--bad); border-radius:10px; padding:6px 8px; cursor:pointer;
    }
    .footerbar{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; align-items:center;
      margin-top:10px;
    }
    .note{ color:var(--muted); font-size:12px; line-height:1.4; }
    .two{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    @media (max-width:560px){ .two{ grid-template-columns:1fr; } }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:flex; align-items:flex-end; justify-content:center;
      padding:12px;
      z-index:999;
    }
    .modal{
      width:min(980px, 100%);
      max-height: 86vh;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 30px 80px rgba(0,0,0,.45);
      display:flex; flex-direction:column;
    }
    .modalHead{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background:rgba(0,0,0,.25);
    }
    .modalHead .h{
      font-weight:900; font-size:13px;
      color:var(--text);
    }
    .modalBody{
      padding:12px;
      overflow:auto;
    }
    .figRow{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .figLeft{
      display:flex; gap:10px; align-items:center;
      min-width: 0;
    }
    .thumb{
      width:54px; height:54px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      overflow:hidden;
      flex: 0 0 auto;
      display:flex; align-items:center; justify-content:center;
    }
    .thumb img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb .ph{
      font-size:10px; color:var(--muted);
      padding:6px; text-align:center; line-height:1.2;
    }
    .mutedSmall{ font-size:11px; color:var(--muted); }
  </style>
</head>
<body>
<header>
  <div>
    <div class="title">ã‚«ãƒãƒãƒª & RE2 åˆ¤å®šãƒ„ãƒ¼ãƒ«ï¼ˆã‚¿ãƒƒãƒ—å…¥åŠ›ï¼‰</div>
    <div class="sub">å½“æ—¥å±¥æ­´ã¯å³ã«è¡¨ç¤ºï¼ä¿å­˜ã¯ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰</div>
  </div>
  <div class="seg" style="gap:8px;">
    <button id="tabK" class="active" type="button">ã‚«ãƒãƒãƒª</button>
    <button id="tabR" type="button">RE2</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h2>
        <span>å…¥åŠ›ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ä¸­å¿ƒï¼‰</span>
        <span class="mini">
          <span class="pill"><span>æ—¥ä»˜</span><span class="v" id="today"></span></span>
        </span>
      </h2>
      <div class="body" id="leftBody"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>
        <span>åˆ¤å®š & å½“æ—¥å±¥æ­´</span>
        <span class="mini">
          <button class="btn small" id="btnResetDay" type="button">å½“æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </span>
      </h2>
      <div class="body">
        <div id="judgeBox"></div>

        <div class="chip">
          <h3>å½“æ—¥å±¥æ­´ï¼ˆè¡¨ç¤º10ä»¶ / ä¿å­˜ã¯å…¨ä»¶ï¼‰</h3>
          <div class="hist" id="hist"></div>
          <div class="footerbar">
            <div class="mini">
              <button class="btn small" id="btnExport" type="button">JSONæ›¸ãå‡ºã—</button>
              <button class="btn small" id="btnImport" type="button">JSONèª­ã¿è¾¼ã¿</button>
              <input id="fileIn" type="file" accept="application/json" style="display:none;" />
            </div>
            <div class="note">â€» å±¥æ­´ã¯ç«¯æœ«ã”ã¨ï¼ˆåˆ¥ã‚¹ãƒãƒ›ã«ã¯è‡ªå‹•åŒæœŸã—ãªã„ï¼‰</div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Storage & Helpers
========================= */
const KEY = "kabare2_v2_counts";
const todayStr = (() => {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
})();
document.getElementById("today").textContent = todayStr;

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function fmtPct(x){
  if(x==null) return "â€”";
  return `${x.toFixed(1)}%`;
}
function nowTs(){
  const d = new Date();
  return d.toLocaleTimeString("ja-JP", {hour:"2-digit", minute:"2-digit"});
}
function uid(){
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function downloadJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* =========================
   Default States
========================= */
function defaultKState(){
  return {
    totalG: "",
    cz: {
      unmei:{a:0,s:0},
      ikoma:{a:0,s:0},
      biba:{a:0,s:0},
    },
    bonus: {
      sjo:0,
      epi:0,
      epi7:0,
      epiLast: null
    },
    char: { male:0, female:0 },
    midBell: { count:"", base:"" },
    notes: ""
  };
}

function buildRE2Meta(){
  // group: white/blue/red/deny/confirm
  return [
    {id:"oddWeak",  group:"white",   name:"ã‚¾ãƒ³ãƒ“(ç”·)/ã‚¾ãƒ³ãƒ“(å¥³)/ã‚¾ãƒ³ãƒ“çŠ¬", tag:"å¥‡æ•°ç¤ºå”†ï¼ˆå¼±ï¼‰"},
    {id:"oddStrong",group:"white",   name:"ã‚¤ãƒ“ãƒ¼/ãƒªãƒƒã‚«ãƒ¼/ãƒšã‚¤ãƒ«ãƒ˜ãƒƒãƒ‰", tag:"å¥‡æ•°ç¤ºå”†ï¼ˆå¼·ï¼‰"},
    {id:"evenWeak", group:"blue",    name:"ãƒ¬ã‚ªãƒ³/ãƒãƒ¼ãƒ“ãƒ³/ç‰¹æ®Šéƒ¨éšŠ", tag:"å¶æ•°ç¤ºå”†ï¼ˆå¼±ï¼‰"},
    {id:"evenStrong",group:"blue",   name:"ã‚¯ãƒ¬ã‚¢/ã‚·ã‚§ãƒªãƒ¼/ã‚¢ãƒãƒƒãƒˆ", tag:"å¶æ•°ç¤ºå”†ï¼ˆå¼·ï¼‰"},
    {id:"hiWeak",   group:"red",     name:"ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆ/ã‚¨ã‚¤ãƒ€ï¼ˆã‚¹ãƒ¼ãƒ„ï¼‰", tag:"é«˜è¨­å®šç¤ºå”†ï¼ˆå¼±ï¼‰"},
    {id:"hiStrong", group:"red",     name:"ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆ/ã‚¨ã‚¤ãƒ€ï¼ˆãƒ‰ãƒ¬ã‚¹ï¼‰", tag:"é«˜è¨­å®šç¤ºå”†ï¼ˆå¼·ï¼‰"},
    {id:"deny1",    group:"deny",    name:"Gç¬¬1å½¢æ…‹", tag:"è¨­å®š1å¦å®š"},
    {id:"deny2",    group:"deny",    name:"Gç¬¬2å½¢æ…‹", tag:"è¨­å®š2å¦å®š"},
    {id:"deny3",    group:"deny",    name:"Gç¬¬3å½¢æ…‹", tag:"è¨­å®š3å¦å®š"},
    {id:"deny4",    group:"deny",    name:"Gç¬¬4å½¢æ…‹", tag:"è¨­å®š4å¦å®š"},
    {id:"ge3",      group:"confirm", name:"è±†è…", tag:"è¨­å®š3ä»¥ä¸Š"},
    {id:"ge4",      group:"confirm", name:"ãƒœã‚¹ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼", tag:"è¨­å®š4ä»¥ä¸Š"},
    {id:"ge5",      group:"confirm", name:"å…¨å“¡é›†åˆ", tag:"è¨­å®š5ä»¥ä¸Š"},
    {id:"eq6",      group:"confirm", name:"ã‚¨ãƒ³ã‚¿ãƒ©ã‚¤ã‚ªãƒ³", tag:"è¨­å®š6ç¢ºå®š"},
  ];
}

function defaultRState(){
  const meta = buildRE2Meta();
  const counts = {};
  for(const m of meta) counts[m.id] = 0;

  return {
    totalG: "",
    cz: { count:0, win:0 },
    at: { count:0 },
    direct: { count:0 },
    through: { count:0 },
    figs: { _meta: meta, counts }
  };
}

/* =========================
   State load/save + migration
========================= */
function loadState(){
  const raw = localStorage.getItem(KEY);
  if(!raw){
    return {
      activeTab: "k",
      day: todayStr,
      k: defaultKState(),
      r: defaultRState(),
      history: []
    };
  }
  try{
    const s = JSON.parse(raw);
    // ensure shape
    if(!s.k) s.k = defaultKState();
    if(!s.r) s.r = defaultRState();
    if(!Array.isArray(s.history)) s.history = [];
    if(!s.day) s.day = todayStr;
    if(!s.activeTab) s.activeTab = "k";

    // ensure RE2 meta+counts exist
    const meta = buildRE2Meta();
    if(!s.r.figs) s.r.figs = { _meta: meta, counts:{} };
    if(!Array.isArray(s.r.figs._meta)) s.r.figs._meta = meta;
    if(!s.r.figs.counts || typeof s.r.figs.counts !== "object") s.r.figs.counts = {};
    for(const m of meta){
      if(typeof s.r.figs.counts[m.id] !== "number") s.r.figs.counts[m.id] = Number(s.r.figs.counts[m.id] || 0);
    }

    return s;
  }catch{
    return {
      activeTab: "k",
      day: todayStr,
      k: defaultKState(),
      r: defaultRState(),
      history: []
    };
  }
}
let state = loadState();

function saveState(){
  localStorage.setItem(KEY, JSON.stringify(state));
}

// Day rollover: keep history but reset per-day counters
if(state.day !== todayStr){
  state.day = todayStr;
  state.k = defaultKState();
  state.r = defaultRState();
  saveState();
}

function addHist(tab, text){
  const item = { id: uid(), day: todayStr, tab, text, ts: nowTs() };
  state.history.unshift(item);
  saveState();
  renderRight();
}
function delHist(id){
  state.history = state.history.filter(x => x.id !== id);
  saveState();
  renderRight();
}
function resetDay(){
  state.history = state.history.filter(x => x.day !== todayStr);
  state.k = defaultKState();
  state.r = defaultRState();
  saveState();
  renderAll();
}

/* =========================
   UI Helpers
========================= */
function mkField(label, innerEl){
  const f = document.createElement("div");
  f.className = "field";
  const l = document.createElement("div");
  l.className = "label";
  l.textContent = label;
  f.appendChild(l);
  f.appendChild(innerEl);
  return f;
}
function makeButton(text, cls, onClick){
  const b = document.createElement("button");
  b.type="button";
  b.className = `btn ${cls||""}`.trim();
  b.textContent = text;
  b.onclick = onClick;
  return b;
}
function tapCounter(title, valueGetter, incFn, decFn, extraBtns=[]){
  const wrap = document.createElement("div");
  wrap.className = "field";
  const l = document.createElement("div");
  l.className = "label";
  l.textContent = title;
  wrap.appendChild(l);

  const line = document.createElement("div");
  line.className = "tapline";

  const pill = document.createElement("div");
  pill.className = "pill";
  pill.innerHTML = `<span class="v">${valueGetter()}</span>`;
  line.appendChild(pill);

  const btns = document.createElement("div");
  btns.className = "tapbtns";
  btns.appendChild(makeButton("+1","small good", ()=> incFn(1)));
  btns.appendChild(makeButton("+10","small good", ()=> incFn(10)));
  btns.appendChild(makeButton("âˆ’1","small bad", ()=> decFn(1)));
  for(const ex of extraBtns) btns.appendChild(ex);
  line.appendChild(btns);

  wrap.appendChild(line);
  return wrap;
}

/* =========================
   Kabaneri reference tables (your provided)
========================= */
const K_REF = {
  bonusAll: {1:237.0,2:230.7,3:214.0,4:186.5,5:171.3,6:151.3},
  stAll: {1:407.9,2:393.2,3:372.4,4:327.2,5:307.3,6:290.6},
  midBell: {1:26.6,2:26.6,3:25.9,4:25.4,5:24.9,6:24.2},
  unmei3: {1:18.7,2:18.8,3:23.5,4:28.3,5:30.6,6:40.7},
  unmei2choice: {1:48.1,2:48.1,3:50.3,4:53.9,5:56.2,6:62.8}
};

function closestSettingFromRate(observedInv, refInvObj){
  if(!isFinite(observedInv) || observedInv<=0) return null;
  let best = null;
  for(const s of [1,2,3,4,5,6]){
    const ref = refInvObj[s];
    const diff = Math.abs(observedInv - ref);
    if(best==null || diff < best.diff) best = {s, diff};
  }
  return best?.s ?? null;
}
function closestSettingFromPct(observedPct, refPctObj){
  if(!isFinite(observedPct)) return null;
  let best=null;
  for(const s of [1,2,3,4,5,6]){
    const ref = refPctObj[s];
    const diff = Math.abs(observedPct - ref);
    if(best==null || diff < best.diff) best = {s, diff};
  }
  return best?.s ?? null;
}

/* =========================
   Tabs
========================= */
const tabK = document.getElementById("tabK");
const tabR = document.getElementById("tabR");
tabK.addEventListener("click", ()=>{ state.activeTab="k"; saveState(); renderAll(); });
tabR.addEventListener("click", ()=>{ state.activeTab="r"; saveState(); renderAll(); });

function renderAll(){
  tabK.classList.toggle("active", state.activeTab==="k");
  tabR.classList.toggle("active", state.activeTab==="r");
  renderLeft();
  renderRight();
}

/* =========================
   Render Left
========================= */
function renderLeft(){
  const root = document.getElementById("leftBody");
  root.innerHTML = "";
  if(state.activeTab === "k"){
    root.appendChild(renderKabaneriLeft());
  }else{
    root.appendChild(renderRE2Left());
  }
}

/* =========================
   Kabaneri Left
========================= */
function renderKabaneriLeft(){
  const box = document.createElement("div");

  const r1 = document.createElement("div"); r1.className="row";
  const g = document.createElement("input");
  g.type="number"; g.inputMode="numeric"; g.placeholder="ä¾‹ï¼‰5200";
  g.value = state.k.totalG;
  g.oninput = () => { state.k.totalG = g.value; saveState(); renderRight(); };
  r1.appendChild(mkField("ç·ã‚²ãƒ¼ãƒ æ•°ï¼ˆä»»æ„ï¼‰", g));
  box.appendChild(r1);

  const czBox = document.createElement("div"); czBox.className="chip";
  czBox.innerHTML = `<h3>CZï¼ˆå‡ºç¾ï¼æˆåŠŸï¼‰ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—</h3>`;
  const two = document.createElement("div"); two.className="two";

  const makeCZ = (label, key) => {
    const c = state.k.cz[key];
    const field = document.createElement("div");
    field.className="field";
    field.innerHTML = `<div class="label">${label}</div>`;
    const line = document.createElement("div"); line.className="tapline";
    const pill = document.createElement("div"); pill.className="pill";
    pill.innerHTML = `<span>å‡ºç¾</span><span class="v">${c.a}</span><span style="opacity:.6;">ï½œ</span><span>æˆåŠŸ</span><span class="v">${c.s}</span>`;
    line.appendChild(pill);

    const btns = document.createElement("div"); btns.className="tapbtns";

    btns.appendChild(makeButton("å‡ºç¾ +1","small good", ()=>{
      c.a += 1;
      saveState(); addHist("k", `${label} å‡ºç¾ +1`);
      renderAll();
    }));
    btns.appendChild(makeButton("æˆåŠŸ +1","small best", ()=>{
      c.a += 1; c.s += 1;
      saveState(); addHist("k", `${label} æˆåŠŸ +1`);
      renderAll();
    }));
    btns.appendChild(makeButton("âˆ’1","small bad", ()=>{
      c.a = Math.max(0, c.a-1);
      c.s = Math.min(c.s, c.a);
      saveState(); addHist("k", `${label} âˆ’1`);
      renderAll();
    }));

    line.appendChild(btns);
    field.appendChild(line);
    return field;
  };

  two.appendChild(makeCZ("ç„¡åCZ", "unmei"));
  two.appendChild(makeCZ("ç”Ÿé§’CZ", "ikoma"));
  two.appendChild(makeCZ("ç¾é¦¬CZ", "biba"));
  czBox.appendChild(two);
  box.appendChild(czBox);

  const bBox = document.createElement("div"); bBox.className="chip";
  bBox.innerHTML = `<h3>ãƒœãƒ¼ãƒŠã‚¹ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ï¼‰</h3>`;
  const bTwo = document.createElement("div"); bTwo.className="two";

  bTwo.appendChild(tapCounter("é§¿åŸãƒœãƒ¼ãƒŠã‚¹ å›æ•°",
    ()=> `${state.k.bonus.sjo}`,
    (n)=>{ state.k.bonus.sjo += n; saveState(); addHist("k", `é§¿åŸ +${n}`); renderAll(); },
    (n)=>{ state.k.bonus.sjo = Math.max(0, state.k.bonus.sjo-n); saveState(); addHist("k", `é§¿åŸ âˆ’${n}`); renderAll(); }
  ));

  const epiField = document.createElement("div");
  epiField.className="field";
  epiField.innerHTML = `<div class="label">ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ï¼ˆè©±æ•°ã‚¿ãƒƒãƒ— / 7è©±ã¯4ä»¥ä¸Šç¢ºå®šï¼‰</div>`;
  const epiLine = document.createElement("div"); epiLine.className="tapline";
  const epiPill = document.createElement("div"); epiPill.className="pill";
  epiPill.innerHTML = `<span>EPå›æ•°</span><span class="v">${state.k.bonus.epi}</span><span style="opacity:.6;">ï½œ</span><span>7è©±</span><span class="v">${state.k.bonus.epi7}</span>`;
  epiLine.appendChild(epiPill);

  const epiBtns = document.createElement("div"); epiBtns.className="tapbtns";
  const minus = makeButton("âˆ’1","small bad", ()=>{
    state.k.bonus.epi = Math.max(0, state.k.bonus.epi-1);
    if(state.k.bonus.epiLast===7) state.k.bonus.epi7 = Math.max(0, state.k.bonus.epi7-1);
    saveState(); addHist("k", "EP âˆ’1"); renderAll();
  });
  epiBtns.appendChild(minus);
  epiLine.appendChild(epiBtns);

  epiField.appendChild(epiLine);
  epiField.appendChild(document.createElement("div")).className="hr";

  const epSel = document.createElement("div");
  epSel.className = "mini";
  for(let i=1;i<=12;i++){
    const b = makeButton(`${i}è©±`,"small", ()=>{
      state.k.bonus.epi += 1;
      state.k.bonus.epiLast = i;
      if(i===7) state.k.bonus.epi7 += 1;
      saveState(); addHist("k", `EP ${i}è©± +1`);
      renderAll();
    });
    epSel.appendChild(b);
  }
  epiField.appendChild(epSel);

  bTwo.appendChild(epiField);
  bBox.appendChild(bTwo);
  box.appendChild(bBox);

  const cBox = document.createElement("div"); cBox.className="chip";
  cBox.innerHTML = `<h3>ã‚­ãƒ£ãƒ©ç´¹ä»‹ï¼ˆç”·å¥³ï¼‰</h3>`;
  const cTwo = document.createElement("div"); cTwo.className="two";

  cTwo.appendChild(tapCounter("ç”·æ€§ã‚­ãƒ£ãƒ©",
    ()=> `${state.k.char.male}`,
    (n)=>{ state.k.char.male += n; saveState(); addHist("k", `ç”·æ€§ +${n}`); renderAll(); },
    (n)=>{ state.k.char.male = Math.max(0, state.k.char.male-n); saveState(); addHist("k", `ç”·æ€§ âˆ’${n}`); renderAll(); }
  ));
  cTwo.appendChild(tapCounter("å¥³æ€§ã‚­ãƒ£ãƒ©",
    ()=> `${state.k.char.female}`,
    (n)=>{ state.k.char.female += n; saveState(); addHist("k", `å¥³æ€§ +${n}`); renderAll(); },
    (n)=>{ state.k.char.female = Math.max(0, state.k.char.female-n); saveState(); addHist("k", `å¥³æ€§ âˆ’${n}`); renderAll(); }
  ));
  cBox.appendChild(cTwo);
  box.appendChild(cBox);

  const opt = document.createElement("div"); opt.className="chip";
  opt.innerHTML = `<h3>è£œåŠ©ï¼ˆä»»æ„ï¼‰</h3>`;
  const optRow = document.createElement("div"); optRow.className="row";

  const bellCnt = document.createElement("input");
  bellCnt.type="number"; bellCnt.inputMode="numeric"; bellCnt.placeholder="ä¾‹ï¼‰210";
  bellCnt.value = state.k.midBell.count;
  bellCnt.oninput = ()=>{ state.k.midBell.count = bellCnt.value; saveState(); renderRight(); };

  const bellBase = document.createElement("input");
  bellBase.type="number"; bellBase.inputMode="numeric"; bellBase.placeholder="æœªå…¥åŠ›ãªã‚‰ç·Gã‚’ä½¿ç”¨";
  bellBase.value = state.k.midBell.base;
  bellBase.oninput = ()=>{ state.k.midBell.base = bellBase.value; saveState(); renderRight(); };

  optRow.appendChild(mkField("å…±é€šä¸­æ®µãƒ™ãƒ« å›æ•°", bellCnt));
  optRow.appendChild(mkField("ä¸­æ®µãƒ™ãƒ«ã®åˆ†æ¯Gï¼ˆä»»æ„ï¼‰", bellBase));
  opt.appendChild(optRow);

  const note = document.createElement("div");
  note.className="note";
  note.innerHTML = `â€» ã‚«ãƒãƒãƒªã¯ã€Œè§£æã§æ•°å€¤ãŒå‡ºã¦ã„ã‚‹è¦ç´ ã€ã‚’ä¸­å¿ƒã«â€œå‚è€ƒè©•ä¾¡â€ã‚’å‡ºã—ã¾ã™ã€‚ATæ€§èƒ½ãªã©è§£æä¸æ˜ãªè¦ç´ ã¯è©•ä¾¡ã«ä½¿ã„ã¾ã›ã‚“ã€‚`;
  opt.appendChild(document.createElement("div")).className="hr";
  opt.appendChild(note);

  box.appendChild(opt);
  return box;
}

/* =========================
   RE2 Left (countsæ–¹å¼ + å…¥åŠ›/ç¢ºèªã‚’åˆ†é›¢)
========================= */
function renderRE2Left(){
  const box = document.createElement("div");

  const r1 = document.createElement("div"); r1.className="row";
  const g = document.createElement("input");
  g.type="number"; g.inputMode="numeric"; g.placeholder="ä¾‹ï¼‰4800";
  g.value = state.r.totalG;
  g.oninput = ()=>{ state.r.totalG = g.value; saveState(); renderRight(); };
  r1.appendChild(mkField("ç·ã‚²ãƒ¼ãƒ æ•°ï¼ˆä»»æ„ï¼‰", g));
  box.appendChild(r1);

  const b = document.createElement("div"); b.className="chip";
  b.innerHTML = `<h3>å›æ•°ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ï¼‰</h3>`;
  const two = document.createElement("div"); two.className="two";

  two.appendChild(tapCounter("CZå›æ•°",
    ()=> `${state.r.cz.count}ï¼ˆæˆåŠŸ ${state.r.cz.win}ï¼‰`,
    (n)=>{ state.r.cz.count += n; saveState(); addHist("r", `CZ +${n}`); renderAll(); },
    (n)=>{ state.r.cz.count = Math.max(0, state.r.cz.count-n); state.r.cz.win = Math.min(state.r.cz.win, state.r.cz.count); saveState(); addHist("r", `CZ âˆ’${n}`); renderAll(); },
    [
      (()=> makeButton("æˆåŠŸ +1","small best", ()=>{
        state.r.cz.count += 1; state.r.cz.win += 1;
        saveState(); addHist("r","CZ æˆåŠŸ +1"); renderAll();
      }))()
    ]
  ));
  two.appendChild(tapCounter("ATå›æ•°",
    ()=> `${state.r.at.count}`,
    (n)=>{ state.r.at.count += n; saveState(); addHist("r", `AT +${n}`); renderAll(); },
    (n)=>{ state.r.at.count = Math.max(0, state.r.at.count-n); saveState(); addHist("r", `AT âˆ’${n}`); renderAll(); }
  ));
  two.appendChild(tapCounter("ATç›´æ’ƒï¼ˆå›æ•°ï¼‰",
    ()=> `${state.r.direct.count}`,
    (n)=>{ state.r.direct.count += n; saveState(); addHist("r", `ç›´æ’ƒ +${n}`); renderAll(); },
    (n)=>{ state.r.direct.count = Math.max(0, state.r.direct.count-n); saveState(); addHist("r", `ç›´æ’ƒ âˆ’${n}`); renderAll(); }
  ));
  two.appendChild(tapCounter("é€£ç¶šCZã‚¹ãƒ«ãƒ¼ï¼ˆç¾åœ¨ï¼‰",
    ()=> `${state.r.through.count}`,
    (n)=>{ state.r.through.count += n; saveState(); addHist("r", `ã‚¹ãƒ«ãƒ¼ +${n}`); renderAll(); },
    (n)=>{ state.r.through.count = Math.max(0, state.r.through.count-n); saveState(); addHist("r", `ã‚¹ãƒ«ãƒ¼ âˆ’${n}`); renderAll(); }
  ));
  b.appendChild(two);
  box.appendChild(b);

  // Figures: input / confirm
  const f = document.createElement("div"); f.className="chip";
  f.innerHTML = `<h3>ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ï¼ˆå…¥åŠ›ï¼ç¢ºèªï¼‰</h3>`;

  const catRow = document.createElement("div");
  catRow.className = "mini";

  catRow.appendChild(makeButton("ç™½ï¼ˆå¥‡æ•°ï¼‰å…¥åŠ›", "small", ()=> openFigurePicker("white")));
  catRow.appendChild(makeButton("é’ï¼ˆå¶æ•°ï¼‰å…¥åŠ›", "small", ()=> openFigurePicker("blue")));
  catRow.appendChild(makeButton("èµ¤ï¼ˆé«˜è¨­å®šï¼‰å…¥åŠ›", "small", ()=> openFigurePicker("red")));
  catRow.appendChild(makeButton("å¦å®šï¼ˆéŠ…ï¼‰å…¥åŠ›", "small warn", ()=> openFigurePicker("deny")));
  catRow.appendChild(makeButton("ç¢ºå®šç³»ï¼ˆéŠ€ã€œè™¹ï¼‰å…¥åŠ›", "small best", ()=> openFigurePicker("confirm")));
  catRow.appendChild(makeButton("å‡ºç¾æ¸ˆã¿ä¸€è¦§ï¼ˆ0éè¡¨ç¤ºï¼‰", "small best", ()=> openAppearedPicker()));

  f.appendChild(catRow);

  const note = document.createElement("div");
  note.className="note";
  note.style.marginTop = "10px";
  note.innerHTML = `â€» å…¥åŠ›ã¯ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰ã€‚ç¢ºèªã¯ã€Œå‡ºç¾æ¸ˆã¿ä¸€è¦§ã€ã§0ã‚’éš ã—ã¦å›æ•°å¤šã„é †ã«è¡¨ç¤ºã€‚åˆ¤å®šã¯ counts ã‚’å‚ç…§ã™ã‚‹ã®ã§ä¸¡æ–¹ã‹ã‚‰åæ˜ ã•ã‚Œã¾ã™ã€‚`;
  f.appendChild(document.createElement("div")).className="hr";
  f.appendChild(note);

  box.appendChild(f);
  return box;
}

/* =========================
   RE2 Modals
========================= */
function openFigurePicker(group){
  const meta = state.r.figs._meta;
  const counts = state.r.figs.counts;

  const titleMap = {
    white:"ç™½ï¼ˆå¥‡æ•°ç¤ºå”†ï¼‰",
    blue:"é’ï¼ˆå¶æ•°ç¤ºå”†ï¼‰",
    red:"èµ¤ï¼ˆé«˜è¨­å®šç¤ºå”†ï¼‰",
    deny:"å¦å®šï¼ˆéŠ…ï¼‰",
    confirm:"ç¢ºå®šç³»ï¼ˆéŠ€ã€œè™¹ï¼‰"
  };

  const list = meta.filter(x => x.group === group);

  const back = document.createElement("div");
  back.className = "modalBack";
  back.onclick = (e)=>{ if(e.target===back) back.remove(); };

  const modal = document.createElement("div");
  modal.className = "modal";

  const head = document.createElement("div");
  head.className = "modalHead";
  head.innerHTML = `<div class="h">RE2ï¼š${titleMap[group] || group}ï¼ˆã‚¿ãƒƒãƒ—ã§ï¼‹1ï¼‰</div>`;
  head.appendChild(makeButton("é–‰ã˜ã‚‹","small bad", ()=> back.remove()));

  const body = document.createElement("div");
  body.className = "modalBody";

  for(const item of list){
    const row = document.createElement("div");
    row.className = "field";

    const top = document.createElement("div");
    top.className = "figRow";

    const leftSide = document.createElement("div");
    leftSide.className = "figLeft";

    const thumb = document.createElement("div");
    thumb.className = "thumb";
    const img = document.createElement("img");
    img.src = `assets/re2_${item.id}.png`;
    img.alt = item.name;
    img.onerror = ()=>{ thumb.innerHTML = `<div class="ph">${item.id.toUpperCase()}</div>`; };
    thumb.appendChild(img);

    const text = document.createElement("div");
    text.style.minWidth = "0";
    const c = Number(counts[item.id]||0);
    text.innerHTML = `
      <div style="font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.name}</div>
      <div class="mutedSmall" style="margin-top:2px">${item.tag} ï½œ å›æ•°ï¼š<b>${c}</b></div>
    `;

    leftSide.appendChild(thumb);
    leftSide.appendChild(text);

    const btns = document.createElement("div");
    btns.className = "tapbtns";
    btns.appendChild(makeButton("+1","small good", (e)=>{
      e.stopPropagation();
      counts[item.id] = Number(counts[item.id]||0) + 1;
      saveState();
      addHist("r", `ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ï¼š${item.name} +1ï¼ˆ${item.tag}ï¼‰`);
      renderAll();
      back.remove(); // é€£æ‰“ã—ã‚„ã™ãã™ã‚‹ãªã‚‰æ®‹ã—ã¦ã‚‚OKã€‚ä»Šå›ã¯èª¤ã‚¿ãƒƒãƒ—é˜²æ­¢ã§é–‰ã˜ã‚‹ã€‚
    }));
    btns.appendChild(makeButton("âˆ’1","small bad", (e)=>{
      e.stopPropagation();
      counts[item.id] = Math.max(0, Number(counts[item.id]||0) - 1);
      saveState();
      addHist("r", `ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ï¼š${item.name} âˆ’1`);
      renderAll();
      // é–‰ã˜ãªã„ï¼ˆèª¿æ•´ç”¨ï¼‰
      text.querySelector("b").textContent = String(counts[item.id]);
    }));

    top.appendChild(leftSide);
    top.appendChild(btns);
    row.appendChild(top);

    // row click = +1
    row.onclick = ()=>{
      counts[item.id] = Number(counts[item.id]||0) + 1;
      saveState();
      addHist("r", `ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ï¼š${item.name} +1ï¼ˆ${item.tag}ï¼‰`);
      renderAll();
      back.remove();
    };

    body.appendChild(row);
  }

  modal.appendChild(head);
  modal.appendChild(body);
  back.appendChild(modal);
  document.body.appendChild(back);
}

function openAppearedPicker(){
  const meta = state.r.figs._meta;
  const counts = state.r.figs.counts;
  const cnt = (id)=> Number(counts[id]||0);

  const groups = [
    {key:"white",   title:"å¥‡æ•°ï¼ˆç™½ï¼‰"},
    {key:"blue",    title:"å¶æ•°ï¼ˆé’ï¼‰"},
    {key:"red",     title:"é«˜è¨­å®šç¤ºå”†ï¼ˆèµ¤ï¼‰"},
    {key:"deny",    title:"å¦å®šï¼ˆéŠ…ï¼‰"},
    {key:"confirm", title:"ç¢ºå®šç³»ï¼ˆéŠ€ã€œè™¹ï¼‰"},
  ];

  const back = document.createElement("div");
  back.className = "modalBack";
  back.onclick = (e)=>{ if(e.target===back) back.remove(); };

  const modal = document.createElement("div");
  modal.className = "modal";

  const head = document.createElement("div");
  head.className = "modalHead";
  head.innerHTML = `<div class="h">RE2ï¼šå‡ºç¾æ¸ˆã¿ä¸€è¦§ï¼ˆ0éè¡¨ç¤º / ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ / å›æ•°å¤šã„é †ï¼‰</div>`;
  head.appendChild(makeButton("é–‰ã˜ã‚‹","small bad", ()=> back.remove()));

  const body = document.createElement("div");
  body.className = "modalBody";

  let any = false;

  for(const g of groups){
    const list = meta
      .filter(x => x.group === g.key)
      .map(x => ({...x, c: cnt(x.id)}))
      .filter(x => x.c > 0)
      .sort((a,b)=> (b.c - a.c) || a.name.localeCompare(b.name,"ja"));

    if(list.length===0) continue;
    any = true;

    const h = document.createElement("div");
    h.className = "label";
    h.style.margin = "6px 2px 8px";
    h.style.fontWeight = "900";
    h.textContent = g.title;
    body.appendChild(h);

    for(const item of list){
      const row = document.createElement("div");
      row.className = "field";

      const top = document.createElement("div");
      top.className = "figRow";

      const leftSide = document.createElement("div");
      leftSide.className = "figLeft";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      const img = document.createElement("img");
      img.src = `assets/re2_${item.id}.png`;
      img.alt = item.name;
      img.onerror = ()=>{ thumb.innerHTML = `<div class="ph">${item.id.toUpperCase()}</div>`; };
      thumb.appendChild(img);

      const text = document.createElement("div");
      text.style.minWidth = "0";
      text.innerHTML = `
        <div style="font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.name}</div>
        <div class="mutedSmall" style="margin-top:2px">${item.tag} ï½œ å›æ•°ï¼š<b>${item.c}</b></div>
      `;

      leftSide.appendChild(thumb);
      leftSide.appendChild(text);

      const btns = document.createElement("div");
      btns.className="tapbtns";
      btns.appendChild(makeButton("+1","small good", (e)=>{
        e.stopPropagation();
        counts[item.id] = cnt(item.id) + 1;
        saveState(); addHist("r", `ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ï¼š${item.name} +1ï¼ˆ${item.tag}ï¼‰`);
        renderAll();
        back.remove(); openAppearedPicker();
      }));
      btns.appendChild(makeButton("âˆ’1","small bad", (e)=>{
        e.stopPropagation();
        counts[item.id] = Math.max(0, cnt(item.id) - 1);
        saveState(); addHist("r", `ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ï¼š${item.name} âˆ’1`);
        renderAll();
        back.remove(); openAppearedPicker();
      }));

      top.appendChild(leftSide);
      top.appendChild(btns);
      row.appendChild(top);
      body.appendChild(row);
    }

    body.appendChild(document.createElement("div")).className="hr";
  }

  if(!any){
    const p = document.createElement("div");
    p.className="note";
    p.textContent = "ã¾ã ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ãŒ1ã¤ã‚‚å…¥åŠ›ã•ã‚Œã¦ãªã„ã‚ˆï¼ˆå‡ºãŸã‚‰ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰å…¥åŠ›ã—ã¦ã­ï¼‰";
    body.appendChild(p);
  }

  modal.appendChild(head);
  modal.appendChild(body);
  back.appendChild(modal);
  document.body.appendChild(back);
}

/* =========================
   Judge Logic
========================= */
function buildKStats(){
  const k = state.k;
  const totalG = Number(k.totalG || 0);

  const bellCount = Number(k.midBell.count || 0);
  const bellBase = Number(k.midBell.base || 0) || totalG;
  let midBellInv = null, est_midbell = null;
  if(bellCount > 0 && bellBase > 0){
    const rate = bellCount / bellBase;
    if(rate > 0) midBellInv = 1 / rate;
    est_midbell = closestSettingFromRate(midBellInv, K_REF.midBell);
  }

  let unmei3Pct = null, est_unmei3 = null;
  if(k.cz.unmei.a > 0){
    unmei3Pct = (k.cz.unmei.s / k.cz.unmei.a) * 100;
    est_unmei3 = closestSettingFromPct(unmei3Pct, K_REF.unmei3);
  }

  return {
    totalG,
    midBellInv,
    est_midbell,
    unmei3Pct,
    est_unmei3,
    bonusInv:null, est_bonus:null,
    stInv:null, est_st:null,
    unmei2Pct:null, est_unmei2:null
  };
}

function judgeKabaneri(){
  const reasons = [];
  const k = state.k;

  if(k.bonus.epi7 > 0){
    return {
      rank:"purple",
      badge:"ğŸŸ£ é«˜è¨­å®šæ¿ƒåš",
      reasons:[ "ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰7è©±ã‚’ç¢ºèªï¼ˆè¨­å®š4ä»¥ä¸Šç¢ºå®šï¼‰" ],
      extra: buildKStats()
    };
  }

  const stats = buildKStats();
  const estimates = [];
  if(stats.est_midbell != null) estimates.push({s: stats.est_midbell, w: 1.0, label:"å…±é€šä¸­æ®µãƒ™ãƒ«"});
  if(stats.est_unmei3 != null) estimates.push({s: stats.est_unmei3, w: 1.7, label:"ç„¡åCZ å°å½¹3é€£çªç ´"});

  let avg = null;
  if(estimates.length){
    let num=0, den=0;
    for(const e of estimates){ num += e.s * e.w; den += e.w; }
    avg = num/den;
  }

  if(avg == null){
    reasons.push("æ•°å€¤è§£æï¼ˆãƒ™ãƒ«ã‚„çªç ´ç‡ï¼‰ã®å…¥åŠ›ãŒå°‘ãªã„ãŸã‚ã€ä»Šå›ã¯â€œå‚¾å‘è¡¨ç¤ºâ€ä¸­å¿ƒã€‚");
    const czTot = k.cz.unmei.a + k.cz.ikoma.a + k.cz.biba.a;
    if(czTot > 0) reasons.push(`CZå‡ºç¾ï¼šåˆè¨ˆ${czTot}å›ï¼ˆç„¡å${k.cz.unmei.a}/ç”Ÿé§’${k.cz.ikoma.a}/ç¾é¦¬${k.cz.biba.a}ï¼‰`);
    if(k.bonus.sjo > 0) reasons.push(`é§¿åŸãƒœãƒ¼ãƒŠã‚¹ï¼š${k.bonus.sjo}å›`);
    return { rank:"yellow", badge:"ğŸŸ¡ ä¸­é–“ã®å¯èƒ½æ€§ã‚ã‚Š", reasons, extra: stats };
  }

  let rank="yellow";
  let badge="ğŸŸ¡ ä¸­é–“ã®å¯èƒ½æ€§ã‚ã‚Š";
  if(avg >= 4.6){ rank="green"; badge="ğŸŸ¢ é«˜è¨­å®šæœŸå¾…"; }
  if(avg >= 5.3){ rank="purple"; badge="ğŸŸ£ é«˜è¨­å®šæœŸå¾…ï¼ˆå¼·ã‚ï¼‰"; }
  if(avg <= 2.3){ rank="red"; badge="ğŸ”´ ä½è¨­å®šå¯„ã‚Š"; }

  if(stats.midBellInv) reasons.push(`å…±é€šä¸­æ®µãƒ™ãƒ«ï¼š1/${stats.midBellInv.toFixed(1)}ï¼ˆè¿‘ã„è¨­å®šï¼š${stats.est_midbell ?? "â€”"}ï¼‰`);
  if(stats.unmei3Pct != null) reasons.push(`ç„¡åCZ çªç ´ç‡ï¼ˆå…¥åŠ›ãƒ™ãƒ¼ã‚¹ï¼‰ï¼š${fmtPct(stats.unmei3Pct)}ï¼ˆè¿‘ã„è¨­å®šï¼š${stats.est_unmei3 ?? "â€”"}ï¼‰`);

  const czTot = k.cz.unmei.a + k.cz.ikoma.a + k.cz.biba.a;
  reasons.push(`CZå‡ºç¾ï¼šåˆè¨ˆ${czTot}å›ï¼ˆç„¡å${k.cz.unmei.a}/ç”Ÿé§’${k.cz.ikoma.a}/ç¾é¦¬${k.cz.biba.a}ï¼‰`);
  reasons.push(`é§¿åŸãƒœãƒ¼ãƒŠã‚¹ï¼š${k.bonus.sjo}å›`);

  const m = k.char.male, f = k.char.female;
  if(m+f >= 6) reasons.push(`ã‚­ãƒ£ãƒ©ç´¹ä»‹ï¼šç”·æ€§${m} / å¥³æ€§${f}ï¼ˆå¶å¥‡ã®å‚¾å‘ï¼‰`);

  reasons.push("â€» è§£æå€¤ã«è¿‘ã„è¦ç´ ã‹ã‚‰ã®â€œå‚è€ƒè©•ä¾¡â€ã€‚æœ€çµ‚åˆ¤æ–­ã¯çŠ¶æ³ã¨åˆã‚ã›ã¦ã­ã€‚");
  return { rank, badge, reasons, extra: stats };
}

function judgeRE2(){
  const r = state.r;
  const meta = r.figs._meta;
  const C = r.figs.counts || {};
  const n = (id)=> Number(C[id]||0);

  const reasons = [];

  // ç¢ºå®šãƒ»å¼·ç¢º
  if(n("eq6") > 0){
    return {
      rank:"purple",
      badge:"ğŸŸ£ é«˜è¨­å®šæ¿ƒåš",
      reasons:[`ã‚¨ãƒ³ã‚¿ãƒ©ã‚¤ã‚ªãƒ³ï¼ˆè¨­å®š6ç¢ºå®šï¼‰ã‚’ç¢ºèªï¼š${n("eq6")}å›`],
      extra:{}
    };
  }
  if(n("ge5") > 0){
    return {
      rank:"purple",
      badge:"ğŸŸ£ é«˜è¨­å®šæ¿ƒåš",
      reasons:[`å…¨å“¡é›†åˆï¼ˆè¨­å®š5ä»¥ä¸Šï¼‰ã‚’ç¢ºèªï¼š${n("ge5")}å›`].concat(parityReasons()),
      extra:{}
    };
  }

  // å¦å®š/ä»¥ä¸Šã§ä¸‹é™ã‚’ä½œã‚‹
  let floor = 1;
  if(n("deny1")>0) floor = Math.max(floor, 2);
  if(n("deny2")>0) floor = Math.max(floor, 3);
  if(n("deny3")>0) floor = Math.max(floor, 4);
  if(n("deny4")>0) floor = Math.max(floor, 5);
  if(n("ge3")>0) floor = Math.max(floor, 3);
  if(n("ge4")>0) floor = Math.max(floor, 4);

  if(n("deny4")>0) reasons.push(`Gç¬¬4å½¢æ…‹ï¼ˆè¨­å®š4å¦å®šï¼‰â†’ è¨­å®š5ä»¥ä¸Šã®å¯èƒ½æ€§ï¼š${n("deny4")}å›`);
  else if(n("deny3")>0) reasons.push(`Gç¬¬3å½¢æ…‹ï¼ˆè¨­å®š3å¦å®šï¼‰â†’ è¨­å®š4ä»¥ä¸Šã®å¯èƒ½æ€§ï¼š${n("deny3")}å›`);
  else if(n("deny2")>0) reasons.push(`Gç¬¬2å½¢æ…‹ï¼ˆè¨­å®š2å¦å®šï¼‰â†’ è¨­å®š3ä»¥ä¸Šã®å¯èƒ½æ€§ï¼š${n("deny2")}å›`);
  else if(n("deny1")>0) reasons.push(`Gç¬¬1å½¢æ…‹ï¼ˆè¨­å®š1å¦å®šï¼‰â†’ è¨­å®š2ä»¥ä¸Šã®å¯èƒ½æ€§ï¼š${n("deny1")}å›`);

  if(n("ge4")>0) reasons.push(`ãƒœã‚¹ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼ï¼ˆè¨­å®š4ä»¥ä¸Šï¼‰ï¼š${n("ge4")}å›`);
  if(n("ge3")>0) reasons.push(`è±†è…ï¼ˆè¨­å®š3ä»¥ä¸Šï¼‰ï¼š${n("ge3")}å›`);

  const hiWeak = n("hiWeak"), hiStrong = n("hiStrong");
  if(hiWeak+hiStrong>0) reasons.push(`é«˜è¨­å®šç¤ºå”†ï¼šå¼±${hiWeak} / å¼·${hiStrong}`);

  reasons.push(...parityReasons());

  const czRate = r.cz.count>0 ? (r.cz.win/r.cz.count)*100 : null;
  if(r.cz.count>0) reasons.push(`CZï¼š${r.cz.count}å›ï¼ˆæˆåŠŸ ${r.cz.win}ï¼‰ æˆåŠŸç‡ ${fmtPct(czRate)}`);
  if(r.direct.count>0) reasons.push(`ATç›´æ’ƒï¼š${r.direct.count}å›`);
  if(r.through.count>0) reasons.push(`é€£ç¶šCZã‚¹ãƒ«ãƒ¼ï¼ˆç¾åœ¨ï¼‰ï¼š${r.through.count}`);

  let rank="yellow";
  let badge="ğŸŸ¡ ä¸­é–“ã®å¯èƒ½æ€§ã‚ã‚Š";
  if(floor >= 4){ rank="green"; badge="ğŸŸ¢ é«˜è¨­å®šæœŸå¾…"; }
  if(floor >= 5){ rank="purple"; badge="ğŸŸ£ é«˜è¨­å®šæ¿ƒåš"; }

  if(floor <= 2 && (hiWeak+hiStrong===0) && r.cz.count>=6 && czRate!=null && czRate<20 && r.direct.count===0){
    rank="red"; badge="ğŸ”´ ä½è¨­å®šå¯„ã‚Š";
    reasons.push("ç¤ºå”†ãŒå¼±ãã€CZã‚‚å™›ã¿åˆã£ã¦ã„ãªã„ãŸã‚æ…é‡ã«ã€‚");
  }

  reasons.push("â€» ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã®ã€Œå¦å®šï¼ä»¥ä¸Šï¼ç¢ºå®šã€ã‚’æœ€å„ªå…ˆã§åæ˜ ã€‚å¥‡å¶ãƒ»é«˜è¨­å®šç¤ºå”†ã¯â€œå‚¾å‘â€ã§ã™ã€‚");
  return { rank, badge, reasons, extra:{} };

  function parityReasons(){
    const oddW = n("oddWeak"), oddS = n("oddStrong");
    const evenW = n("evenWeak"), evenS = n("evenStrong");
    const oddScore = oddW*1 + oddS*2;
    const evenScore = evenW*1 + evenS*2;
    const total = oddScore + evenScore;
    if(total < 3) return [];
    const t = (oddScore>evenScore) ? "å¥‡æ•°å¯„ã‚Š" : (evenScore>oddScore ? "å¶æ•°å¯„ã‚Š" : "æ‹®æŠ—");
    return [`å¥‡å¶ç¤ºå”†ï¼ˆå‚¾å‘ï¼‰ï¼š${t}ï¼ˆå¥‡:å¼±${oddW}/å¼·${oddS} ï½œ å¶:å¼±${evenW}/å¼·${evenS}ï¼‰`];
  }
}

/* =========================
   Render Right
========================= */
function renderRight(){
  const judgeBox = document.getElementById("judgeBox");
  judgeBox.innerHTML = "";

  const res = (state.activeTab==="k") ? judgeKabaneri() : judgeRE2();

  const rankDiv = document.createElement("div");
  rankDiv.className = "rank";

  const badge = document.createElement("div");
  badge.className = "badge " + (
    res.rank==="red" ? "b-red" :
    res.rank==="yellow" ? "b-yellow" :
    res.rank==="green" ? "b-green" : "b-purple"
  );
  badge.textContent = res.badge;

  rankDiv.appendChild(badge);

  const info = document.createElement("div");
  info.className = "sub";
  info.textContent = (state.activeTab==="k")
    ? "ã‚«ãƒãƒãƒªï¼šè§£æå€¤ã«åŸºã¥ãè¿‘ä¼¼ï¼ˆå‚è€ƒï¼‰ï¼‹ã‚ãªãŸé‡è¦–ï¼ˆCZ/é§¿åŸï¼‰"
    : "RE2ï¼šãƒ•ã‚£ã‚®ãƒ¥ã‚¢å„ªå…ˆï¼ˆå¦å®š/ä»¥ä¸Š/ç¢ºå®šï¼‰ï¼‹æŒ™å‹•ã¯è£œåŠ©ï¼ˆcountsæ–¹å¼ã§åæ˜ ï¼‰";
  rankDiv.appendChild(info);

  judgeBox.appendChild(rankDiv);

  const reason = document.createElement("div");
  reason.className="reason";
  const ul = document.createElement("ul");
  for(const r of res.reasons){
    const li = document.createElement("li");
    li.textContent = r;
    ul.appendChild(li);
  }
  reason.appendChild(ul);
  judgeBox.appendChild(reason);

  const hist = document.getElementById("hist");
  hist.innerHTML = "";
  const todays = state.history.filter(x=>x.day===todayStr);
  const show = todays.slice(0,10);
  if(show.length===0){
    const p = document.createElement("div");
    p.className="note";
    p.textContent = "ã¾ã å½“æ—¥å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã®ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¨˜éŒ²ã—ã¦ã­ã€‚";
    hist.appendChild(p);
  }else{
    for(const it of show){
      const div = document.createElement("div");
      div.className="item";
      const left = document.createElement("div");
      left.className="t";
      left.textContent = (it.tab==="k"?"[ã‚«ãƒãƒãƒª] ":"[RE2] ") + it.text;
      const right = document.createElement("div");
      right.className="d";
      right.innerHTML = `${it.ts} <button class="x" type="button">å‰Šé™¤</button>`;
      right.querySelector("button").onclick = ()=>delHist(it.id);
      div.appendChild(left);
      div.appendChild(right);
      hist.appendChild(div);
    }
  }
}

/* =========================
   Buttons
========================= */
document.getElementById("btnResetDay").addEventListener("click", ()=>{
  if(confirm("å½“æ—¥ã®å…¥åŠ›ã¨å½“æ—¥å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ")){
    resetDay();
  }
});
document.getElementById("btnExport").addEventListener("click", ()=>{
  const payload = {
    exported_at: new Date().toISOString(),
    app: "kabare2_v2_counts",
    state
  };
  downloadJSON(payload, `kabare2_${todayStr}.json`);
});
document.getElementById("btnImport").addEventListener("click", ()=>{
  document.getElementById("fileIn").click();
});
document.getElementById("fileIn").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const obj = JSON.parse(txt);
    if(!obj || !obj.state) throw new Error("invalid");

    state = obj.state;

    // day rollover handling
    if(state.day !== todayStr){
      state.day = todayStr;
      state.k = defaultKState();
      state.r = defaultRState();
    }

    // ensure RE2 counts/meta
    const meta = buildRE2Meta();
    if(!state.r) state.r = defaultRState();
    if(!state.r.figs) state.r.figs = { _meta: meta, counts:{} };
    state.r.figs._meta = meta;
    if(!state.r.figs.counts || typeof state.r.figs.counts !== "object") state.r.figs.counts = {};
    for(const m of meta){
      state.r.figs.counts[m.id] = Number(state.r.figs.counts[m.id] || 0);
    }

    if(!Array.isArray(state.history)) state.history = [];
    if(!state.activeTab) state.activeTab = "k";

    saveState();
    renderAll();
    alert("èª­ã¿è¾¼ã¿å®Œäº†ï¼");
  }catch{
    alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ã­ã€‚");
  }finally{
    e.target.value = "";
  }
});

/* =========================
   Init
========================= */
renderAll();
</script>
</body>
</html>
