<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ã‚«ãƒãƒãƒª & RE2 åˆ¤å®šãƒ„ãƒ¼ãƒ«ï¼ˆæœ€æ–°ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111826; --panel2:#0f1622; --text:#e8eef7; --muted:#a7b3c7;
      --line:#243247; --btn:#1a2435; --btn2:#182033; --good:#26d07c; --warn:#ffcc66; --bad:#ff5d5d; --best:#b98cff;
      --chip:#162033;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Hiragino Sans", "Noto Sans JP", Arial, sans-serif;
      background:linear-gradient(180deg, #070b10 0%, var(--bg) 70%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,15,20,.86); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .title{ font-weight:700; font-size:14px; letter-spacing:.2px; }
    .sub{ font-size:12px; color:var(--muted); }
    .wrap{ padding:12px; max-width:1200px; margin:0 auto; }
    .grid{
      display:grid; gap:12px;
      grid-template-columns: 1.1fr .9fr;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns:1fr; }
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0; padding:12px 12px 10px;
      font-size:14px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .body{ padding:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1 1 auto; }
    .field{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      min-width: 160px;
    }
    .label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="number"], input[type="text"], select{
      width:100%;
      background:rgba(255,255,255,.04);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      font-size:14px;
      outline:none;
    }
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .seg button{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:.12s;
      flex: 1 1 auto;
      min-width: 120px;
    }
    .seg button:hover{ transform: translateY(-1px); }
    .seg button.active{
      border-color: rgba(185,140,255,.8);
      box-shadow: 0 0 0 3px rgba(185,140,255,.12);
    }
    .mini{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.2);
      font-size:13px;
      color:var(--text);
      user-select:none;
    }
    .pill .v{ font-weight:700; }
    .tapline{
      display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .tapbtns{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .btn{
      background:var(--btn2);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      transition:.12s;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.good{ border-color: rgba(38,208,124,.5); }
    .btn.bad{ border-color: rgba(255,93,93,.5); }
    .btn.warn{ border-color: rgba(255,204,102,.55); }
    .btn.best{ border-color: rgba(185,140,255,.6); }
    .btn.small{ padding:8px 10px; font-size:12px; border-radius:10px; }
    .btn.ghost{ background:transparent; }
    .chip{
      background:var(--chip);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      margin-top:10px;
    }
    .chip h3{ margin:0 0 8px; font-size:13px; color:var(--muted); font-weight:600; }
    .rank{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.2);
      margin-bottom:10px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:.2px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .b-red{ color:var(--bad); border-color:rgba(255,93,93,.45); }
    .b-yellow{ color:var(--warn); border-color:rgba(255,204,102,.45); }
    .b-green{ color:var(--good); border-color:rgba(38,208,124,.45); }
    .b-purple{ color:var(--best); border-color:rgba(185,140,255,.55); }
    .reason{
      font-size:13px; color:var(--text);
      line-height:1.5;
      margin:8px 0 0;
    }
    .reason ul{ margin:8px 0 0 18px; color:var(--muted); }
    .hr{ height:1px; background:var(--line); margin:10px 0; }
    .hist{
      max-height: 360px;
      overflow:auto;
      padding-right:6px;
    }
    .hist .item{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
      font-size:12px;
    }
    .hist .item .t{ color:var(--text); line-height:1.35; }
    .hist .item .d{ color:var(--muted); font-size:11px; white-space:nowrap; }
    .hist .item .x{
      background:transparent; border:1px solid rgba(255,93,93,.4);
      color:var(--bad); border-radius:10px; padding:6px 8px; cursor:pointer;
    }
    .footerbar{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; align-items:center;
      margin-top:10px;
    }
    .note{ color:var(--muted); font-size:12px; line-height:1.4; }
    .two{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    @media (max-width:560px){ .two{ grid-template-columns:1fr; } }
    details summary{
      cursor:pointer;
      color:var(--text);
      font-weight:700;
      list-style:none;
    }
    details summary::-webkit-details-marker{ display:none; }
    .krow{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    .krow .k{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:6px 8px; border-radius:10px;
      background:rgba(0,0,0,.18);
    }
  </style>
</head>
<body>
<header>
  <div>
    <div class="title">ã‚«ãƒãƒãƒª & RE2 åˆ¤å®šãƒ„ãƒ¼ãƒ«ï¼ˆæœ€æ–°ç‰ˆï¼‰</div>
    <div class="sub">å½“æ—¥å±¥æ­´ã¯å³ã«è¡¨ç¤ºï¼ä¿å­˜ã¯ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰</div>
  </div>
  <div class="seg" style="gap:8px;">
    <button id="tabK" class="active" type="button">ã‚«ãƒãƒãƒª</button>
    <button id="tabR" type="button">RE2</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h2>
        <span>å…¥åŠ›</span>
        <span class="mini">
          <span class="pill"><span>æ—¥ä»˜</span><span class="v" id="today"></span></span>
        </span>
      </h2>
      <div class="body" id="leftBody"></div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>
        <span>åˆ¤å®š & å½“æ—¥å±¥æ­´</span>
        <span class="mini">
          <button class="btn small" id="btnResetDay" type="button">å½“æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </span>
      </h2>
      <div class="body">
        <div id="judgeBox"></div>

        <div class="chip">
          <h3>å½“æ—¥å±¥æ­´ï¼ˆè¡¨ç¤º10ä»¶ / ä¿å­˜ã¯å…¨ä»¶ï¼‰</h3>
          <div class="hist" id="hist"></div>
          <div class="footerbar">
            <div class="mini">
              <button class="btn small" id="btnExport" type="button">JSONæ›¸ãå‡ºã—</button>
              <button class="btn small" id="btnImport" type="button">JSONèª­ã¿è¾¼ã¿</button>
              <input id="fileIn" type="file" accept="application/json" style="display:none;" />
            </div>
            <div class="note">â€» å±¥æ­´ã¯ç«¯æœ«ã”ã¨ï¼ˆåˆ¥ã‚¹ãƒãƒ›ã«ã¯è‡ªå‹•åŒæœŸã—ãªã„ï¼‰</div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Storage & Helpers
========================= */
const KEY = "kabare2_v2";
const todayStr = (() => {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
})();
document.getElementById("today").textContent = todayStr;

function loadState(){
  const raw = localStorage.getItem(KEY);
  if(!raw){
    return {
      activeTab: "k",
      day: todayStr,
      k: defaultKState(),
      r: defaultRState(),
      history: [] // {id, day, tab, text, ts}
    };
  }
  try{
    const s = JSON.parse(raw);
    if(!s.k) s.k = defaultKState();
    if(!s.r) s.r = defaultRState();
    if(!Array.isArray(s.history)) s.history = [];
    if(!s.day) s.day = todayStr;
    if(!s.activeTab) s.activeTab = "k";
    // migration safety
    if(!s.r.ui) s.r.ui = { subtab:"input" };
    if(!s.r.direct) s.r.direct = { total:0, replay:0, weak:0, strong:0, unknown:0 };
    if(!s.r.at) s.r.at = { count:0, stage: {police:0, sewer:0, lab:0, escape:0} };
    return s;
  }catch{
    return {
      activeTab: "k",
      day: todayStr,
      k: defaultKState(),
      r: defaultRState(),
      history: []
    };
  }
}
function saveState(){
  localStorage.setItem(KEY, JSON.stringify(state));
}
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function nowTs(){
  const d = new Date();
  return d.toLocaleTimeString("ja-JP", {hour:"2-digit", minute:"2-digit"});
}
function addHist(tab, text){
  const item = { id: uid(), day: todayStr, tab, text, ts: nowTs() };
  state.history.unshift(item);
  saveState();
  renderRight();
}
function delHist(id){
  state.history = state.history.filter(x => x.id !== id);
  saveState();
  renderRight();
}
function resetDay(){
  state.history = state.history.filter(x => x.day !== todayStr);
  state.k = defaultKState();
  state.r = defaultRState();
  saveState();
  renderAll();
}
function downloadJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function softmax(scores){
  const keys = Object.keys(scores);
  const vals = keys.map(k=>scores[k]);
  const mx = Math.max(...vals);
  const exps = vals.map(v => Math.exp(v - mx));
  const sum = exps.reduce((a,b)=>a+b,0) || 1;
  const out = {};
  keys.forEach((k,i)=> out[k] = exps[i]/sum);
  return out;
}
function fmtPct(p){
  if(!isFinite(p)) return "â€”";
  return (p*100).toFixed(1) + "%";
}

/* =========================
   Default States
========================= */
function defaultKState(){
  return {
    totalG: "",
    cz: {
      unmei:{a:0,s:0},
      ikoma:{a:0,s:0},
      biba:{a:0,s:0},
    },
    bonus: {
      sjo:0,
      epi:0,
      epi7:0,
      epiLast: null
    },
    char: { male:0, female:0 },
    midBell: { count:"", base:"" },
  };
}
function defaultRState(){
  return {
    ui: { subtab:"input" }, // input | judge | daylog
    totalG: "",
    cz: { count:0, win:0 },  // Gãƒãƒˆãƒ«ç­‰
    at: { count:0, stage: {police:0, sewer:0, lab:0, escape:0} }, // AT count auto-incremented
    direct: { total:0, replay:0, weak:0, strong:0, unknown:0 },   // ATç›´æ’ƒï¼ˆå¥‘æ©Ÿåˆ¥ï¼‰
    figs: initRE2Figs(),
  };
}

/* =========================
   RE2 Figures meta
========================= */
function initRE2Figs(){
  const list = [
    // parity
    {key:"oddWeak", name:"ã‚¾ãƒ³ãƒ“(ç”·)/ã‚¾ãƒ³ãƒ“(å¥³)/ã‚¾ãƒ³ãƒ“çŠ¬", tag:"å¥‡æ•°ç¤ºå”†ï¼ˆå¼±ï¼‰", cat:"odd"},
    {key:"oddStrong", name:"ã‚¤ãƒ“ãƒ¼/ãƒªãƒƒã‚«ãƒ¼/ãƒšã‚¤ãƒ«ãƒ˜ãƒƒãƒ‰", tag:"å¥‡æ•°ç¤ºå”†ï¼ˆå¼·ï¼‰", cat:"odd"},
    {key:"evenWeak", name:"ãƒ¬ã‚ªãƒ³/ãƒãƒ¼ãƒ“ãƒ³/ç‰¹æ®Šéƒ¨éšŠ", tag:"å¶æ•°ç¤ºå”†ï¼ˆå¼±ï¼‰", cat:"even"},
    {key:"evenStrong", name:"ã‚¯ãƒ¬ã‚¢/ã‚·ã‚§ãƒªãƒ¼/ã‚¢ãƒãƒƒãƒˆ", tag:"å¶æ•°ç¤ºå”†ï¼ˆå¼·ï¼‰", cat:"even"},
    // hi
    {key:"hiWeak", name:"ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆ/ã‚¨ã‚¤ãƒ€ï¼ˆã‚¹ãƒ¼ãƒ„ï¼‰", tag:"é«˜è¨­å®šç¤ºå”†ï¼ˆå¼±ï¼‰", cat:"hi"},
    {key:"hiStrong", name:"ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¿ã‚¤ãƒ©ãƒ³ãƒˆ/ã‚¨ã‚¤ãƒ€ï¼ˆãƒ‰ãƒ¬ã‚¹ï¼‰", tag:"é«˜è¨­å®šç¤ºå”†ï¼ˆå¼·ï¼‰", cat:"hi"},
    // deny
    {key:"deny1", name:"Gç¬¬1å½¢æ…‹", tag:"è¨­å®š1å¦å®š", cat:"deny"},
    {key:"deny2", name:"Gç¬¬2å½¢æ…‹", tag:"è¨­å®š2å¦å®š", cat:"deny"},
    {key:"deny3", name:"Gç¬¬3å½¢æ…‹", tag:"è¨­å®š3å¦å®š", cat:"deny"},
    {key:"deny4", name:"Gç¬¬4å½¢æ…‹", tag:"è¨­å®š4å¦å®š", cat:"deny"},
    // floors
    {key:"ge3", name:"è±†è…", tag:"è¨­å®š3ä»¥ä¸Š", cat:"floor"},
    {key:"ge4", name:"ãƒœã‚¹ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¼", tag:"è¨­å®š4ä»¥ä¸Š", cat:"floor"},
    {key:"ge5", name:"å…¨å“¡é›†åˆ", tag:"è¨­å®š5ä»¥ä¸Š", cat:"floor"},
    {key:"eq6", name:"ã‚¨ãƒ³ã‚¿ãƒ©ã‚¤ã‚ªãƒ³", tag:"è¨­å®š6ç¢ºå®š", cat:"floor"},
  ];
  const obj = {};
  for(const f of list) obj[f.key] = 0;
  obj._meta = list;
  return obj;
}

/* =========================
   App State
========================= */
let state = loadState();
if(state.day !== todayStr){
  state.day = todayStr;
  state.k = defaultKState();
  state.r = defaultRState();
  saveState();
}

/* =========================
   Tabs
========================= */
const tabK = document.getElementById("tabK");
const tabR = document.getElementById("tabR");
tabK.addEventListener("click", ()=>{ state.activeTab="k"; saveState(); renderAll(); });
tabR.addEventListener("click", ()=>{ state.activeTab="r"; saveState(); renderAll(); });

/* =========================
   UI helpers
========================= */
function mkField(label, innerEl){
  const f = document.createElement("div");
  f.className = "field";
  const l = document.createElement("div");
  l.className = "label";
  l.textContent = label;
  f.appendChild(l);
  f.appendChild(innerEl);
  return f;
}
function btn(text, cls, onClick){
  const b = document.createElement("button");
  b.type="button";
  b.className = `btn ${cls||""}`.trim();
  b.textContent = text;
  b.onclick = onClick;
  return b;
}
function smallBtn(text, cls, onClick){
  const b = document.createElement("button");
  b.type="button";
  b.className = `btn small ${cls||""}`.trim();
  b.textContent = text;
  b.onclick = onClick;
  return b;
}
function tapCounter(title, valueGetter, incFn, decFn, extraBtns=[]){
  const wrap = document.createElement("div");
  wrap.className = "field";
  const l = document.createElement("div");
  l.className = "label";
  l.textContent = title;
  wrap.appendChild(l);

  const line = document.createElement("div");
  line.className = "tapline";

  const pill = document.createElement("div");
  pill.className = "pill";
  pill.innerHTML = `<span class="v">${valueGetter()}</span>`;
  line.appendChild(pill);

  const btns = document.createElement("div");
  btns.className = "tapbtns";
  btns.appendChild(smallBtn("+1","good", ()=>incFn(1)));
  btns.appendChild(smallBtn("+10","good", ()=>incFn(10)));
  btns.appendChild(smallBtn("âˆ’1","bad", ()=>decFn(1)));
  for(const ex of extraBtns) btns.appendChild(ex);
  line.appendChild(btns);

  wrap.appendChild(line);
  return wrap;
}

/* =========================
   Render All
========================= */
function renderAll(){
  tabK.classList.toggle("active", state.activeTab==="k");
  tabR.classList.toggle("active", state.activeTab==="r");
  renderLeft();
  renderRight();
}

function renderLeft(){
  const root = document.getElementById("leftBody");
  root.innerHTML = "";
  if(state.activeTab === "k"){
    root.appendChild(renderKabaneriLeft());
  }else{
    root.appendChild(renderRE2Left());
  }
}

/* =========================
   Kabaneri Left (ç°¡æ˜“ã®ã¾ã¾)
========================= */
function renderKabaneriLeft(){
  const box = document.createElement("div");

  const r1 = document.createElement("div"); r1.className="row";
  const g = document.createElement("input");
  g.type="number"; g.inputMode="numeric"; g.placeholder="ä¾‹ï¼‰5200";
  g.value = state.k.totalG;
  g.oninput = () => { state.k.totalG = g.value; saveState(); renderRight(); };
  r1.appendChild(mkField("ç·ã‚²ãƒ¼ãƒ æ•°ï¼ˆä»»æ„ï¼‰", g));
  box.appendChild(r1);

  const czBox = document.createElement("div"); czBox.className="chip";
  czBox.innerHTML = `<h3>CZï¼ˆå‡ºç¾ï¼æˆåŠŸï¼‰</h3>`;
  const two = document.createElement("div"); two.className="two";

  const makeCZ = (label, key) => {
    const c = state.k.cz[key];
    const field = document.createElement("div");
    field.className="field";
    field.innerHTML = `<div class="label">${label}</div>`;
    const line = document.createElement("div"); line.className="tapline";
    const pill = document.createElement("div"); pill.className="pill";
    pill.innerHTML = `<span>å‡ºç¾</span><span class="v">${c.a}</span><span style="opacity:.6;">ï½œ</span><span>æˆåŠŸ</span><span class="v">${c.s}</span>`;
    line.appendChild(pill);

    const btns = document.createElement("div"); btns.className="tapbtns";
    btns.appendChild(smallBtn("å‡ºç¾ +1","good", ()=>{
      c.a += 1; saveState(); addHist("k", `${label} å‡ºç¾ +1`); renderAll();
    }));
    btns.appendChild(smallBtn("æˆåŠŸ +1","best", ()=>{
      c.a += 1; c.s += 1; saveState(); addHist("k", `${label} æˆåŠŸ +1`); renderAll();
    }));
    btns.appendChild(smallBtn("âˆ’1","bad", ()=>{
      c.a = Math.max(0, c.a-1); c.s = Math.min(c.s, c.a);
      saveState(); addHist("k", `${label} âˆ’1`); renderAll();
    }));
    line.appendChild(btns);
    field.appendChild(line);
    return field;
  };

  two.appendChild(makeCZ("ç„¡åCZ", "unmei"));
  two.appendChild(makeCZ("ç”Ÿé§’CZ", "ikoma"));
  two.appendChild(makeCZ("ç¾é¦¬CZ", "biba"));
  czBox.appendChild(two);
  box.appendChild(czBox);

  const bBox = document.createElement("div"); bBox.className="chip";
  bBox.innerHTML = `<h3>ãƒœãƒ¼ãƒŠã‚¹</h3>`;
  const bTwo = document.createElement("div"); bTwo.className="two";

  bTwo.appendChild(tapCounter("é§¿åŸãƒœãƒ¼ãƒŠã‚¹ å›æ•°",
    ()=> `${state.k.bonus.sjo}`,
    (n)=>{ state.k.bonus.sjo += n; saveState(); addHist("k", `é§¿åŸ +${n}`); renderAll(); },
    (n)=>{ state.k.bonus.sjo = Math.max(0, state.k.bonus.sjo-n); saveState(); addHist("k", `é§¿åŸ âˆ’${n}`); renderAll(); }
  ));

  const epiField = document.createElement("div");
  epiField.className="field";
  epiField.innerHTML = `<div class="label">ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ï¼ˆè©±æ•°ã‚¿ãƒƒãƒ— / 7è©±=è¨­å®š4ä»¥ä¸Šç¢ºå®šï¼‰</div>`;
  const epiLine = document.createElement("div"); epiLine.className="tapline";
  const epiPill = document.createElement("div"); epiPill.className="pill";
  epiPill.innerHTML = `<span>EPå›æ•°</span><span class="v">${state.k.bonus.epi}</span><span style="opacity:.6;">ï½œ</span><span>7è©±</span><span class="v">${state.k.bonus.epi7}</span>`;
  epiLine.appendChild(epiPill);

  const epiBtns = document.createElement("div"); epiBtns.className="tapbtns";
  const minus = smallBtn("âˆ’1","bad", ()=>{
    state.k.bonus.epi = Math.max(0, state.k.bonus.epi-1);
    if(state.k.bonus.epiLast===7) state.k.bonus.epi7 = Math.max(0, state.k.bonus.epi7-1);
    saveState(); addHist("k", "EP âˆ’1"); renderAll();
  });
  epiBtns.appendChild(minus);
  epiLine.appendChild(epiBtns);

  const epSel = document.createElement("div"); epSel.className="mini";
  for(let i=1;i<=12;i++){
    epSel.appendChild(smallBtn(`${i}è©±`,"", ()=>{
      state.k.bonus.epi += 1;
      state.k.bonus.epiLast = i;
      if(i===7) state.k.bonus.epi7 += 1;
      saveState(); addHist("k", `EP ${i}è©± +1`); renderAll();
    }));
  }

  epiField.appendChild(epiLine);
  epiField.appendChild(document.createElement("div")).className="hr";
  epiField.appendChild(epSel);

  bTwo.appendChild(epiField);
  bBox.appendChild(bTwo);
  box.appendChild(bBox);

  const cBox = document.createElement("div"); cBox.className="chip";
  cBox.innerHTML = `<h3>ã‚­ãƒ£ãƒ©ç´¹ä»‹ï¼ˆç”·å¥³ï¼‰</h3>`;
  const cTwo = document.createElement("div"); cTwo.className="two";
  cTwo.appendChild(tapCounter("ç”·æ€§ã‚­ãƒ£ãƒ©", ()=> `${state.k.char.male}`,
    (n)=>{ state.k.char.male += n; saveState(); addHist("k", `ç”·æ€§ +${n}`); renderAll(); },
    (n)=>{ state.k.char.male = Math.max(0, state.k.char.male-n); saveState(); addHist("k", `ç”·æ€§ âˆ’${n}`); renderAll(); }
  ));
  cTwo.appendChild(tapCounter("å¥³æ€§ã‚­ãƒ£ãƒ©", ()=> `${state.k.char.female}`,
    (n)=>{ state.k.char.female += n; saveState(); addHist("k", `å¥³æ€§ +${n}`); renderAll(); },
    (n)=>{ state.k.char.female = Math.max(0, state.k.char.female-n); saveState(); addHist("k", `å¥³æ€§ âˆ’${n}`); renderAll(); }
  ));
  cBox.appendChild(cTwo);
  box.appendChild(cBox);

  return box;
}

/* =========================
   RE2 Left (ã‚µãƒ–ã‚¿ãƒ–ä»˜ã)
========================= */
function renderRE2Left(){
  const box = document.createElement("div");

  // Subtabs
  const sub = document.createElement("div");
  sub.className="seg";
  const mkSub = (key, label) => {
    const b = document.createElement("button");
    b.type="button";
    b.classList.toggle("active", state.r.ui.subtab===key);
    b.textContent = label;
    b.onclick = ()=>{ state.r.ui.subtab=key; saveState(); renderLeft(); renderRight(); };
    return b;
  };
  sub.appendChild(mkSub("input","å…¥åŠ›"));
  sub.appendChild(mkSub("judge","åˆ¤å®š"));
  sub.appendChild(mkSub("daylog","å½“æ—¥å…¨å±¥æ­´"));
  box.appendChild(sub);

  // Total games
  const r1 = document.createElement("div"); r1.className="row";
  const g = document.createElement("input");
  g.type="number"; g.inputMode="numeric"; g.placeholder="ä¾‹ï¼‰1000ï¼ˆåºç›¤åˆ¤å®šãŒå¤‰ã‚ã‚‹ï¼‰";
  g.value = state.r.totalG;
  g.oninput = ()=>{ state.r.totalG = g.value; saveState(); renderRight(); renderLeft(); };
  r1.appendChild(mkField("ç·ã‚²ãƒ¼ãƒ æ•°ï¼ˆç›®å®‰ã§OKï¼‰", g));
  box.appendChild(r1);

  if(state.r.ui.subtab==="input"){
    box.appendChild(renderRE2Input());
  }else if(state.r.ui.subtab==="judge"){
    box.appendChild(renderRE2JudgePanel());
  }else{
    box.appendChild(renderRE2DayLogPanel());
  }

  return box;
}

function renderRE2Input(){
  const box = document.createElement("div");

  // CZ + AT (ATã¯è‡ªå‹•)
  const b = document.createElement("div"); b.className="chip";
  b.innerHTML = `<h3>é€šå¸¸æŒ™å‹•ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ï¼‰</h3>`;
  const two = document.createElement("div"); two.className="two";

  // CZ count + success => auto AT+1
  two.appendChild(tapCounter("CZå›æ•°ï¼ˆGãƒãƒˆãƒ«ç­‰ï¼‰",
    ()=> `${state.r.cz.count}ï¼ˆæˆåŠŸ ${state.r.cz.win}ï¼‰`,
    (n)=>{ state.r.cz.count += n; saveState(); addHist("r", `CZ +${n}`); renderAll(); },
    (n)=>{ state.r.cz.count = Math.max(0, state.r.cz.count-n); state.r.cz.win = Math.min(state.r.cz.win, state.r.cz.count);
          saveState(); addHist("r", `CZ âˆ’${n}`); renderAll(); },
    [
      (()=>{ const bb = smallBtn("æˆåŠŸ +1ï¼ˆAT+1ï¼‰","best", ()=>{
        state.r.cz.count += 1;
        state.r.cz.win += 1;
        state.r.at.count += 1; // auto
        saveState();
        addHist("r","CZ æˆåŠŸ +1ï¼ˆAT+1ï¼‰");
        renderAll();
      }); return bb; })()
    ]
  ));

  // AT count (no tap)
  {
    const f = document.createElement("div");
    f.className="field";
    f.innerHTML = `<div class="label">ATå›æ•°ï¼ˆè‡ªå‹•ã‚«ã‚¦ãƒ³ãƒˆï¼‰</div>`;
    const line = document.createElement("div"); line.className="tapline";
    const pill = document.createElement("div"); pill.className="pill";
    pill.innerHTML = `<span>AT</span><span class="v">${state.r.at.count}</span>`;
    line.appendChild(pill);
    const btns = document.createElement("div"); btns.className="tapbtns";
    btns.appendChild(smallBtn("âˆ’1ï¼ˆä¿®æ­£ï¼‰","bad", ()=>{
      state.r.at.count = Math.max(0, state.r.at.count-1);
      saveState(); addHist("r","AT âˆ’1ï¼ˆä¿®æ­£ï¼‰"); renderAll();
    }));
    line.appendChild(btns);
    f.appendChild(line);
    two.appendChild(f);
  }

  // ATé–‹å§‹ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆATãƒ¬ãƒ™ãƒ«æ¨æ¸¬ã®ææ–™ï¼‰
  {
    const f = document.createElement("div");
    f.className="field";
    f.innerHTML = `<div class="label">ATé–‹å§‹ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆè¨˜éŒ²ç”¨ / æ¯”ç‡åˆ¤å®šã«ä½¿ç”¨ï¼‰</div>`;
    const line = document.createElement("div"); line.className="tapline";
    const pill = document.createElement("div"); pill.className="pill";
    const s = state.r.at.stage;
    pill.innerHTML = `<span>è­¦å¯Ÿç½²</span><span class="v">${s.police}</span>
      <span style="opacity:.6;">ï½œ</span><span>ä¸‹æ°´é“</span><span class="v">${s.sewer}</span>
      <span style="opacity:.6;">ï½œ</span><span>ç ”ç©¶æ‰€</span><span class="v">${s.lab}</span>
      <span style="opacity:.6;">ï½œ</span><span>è„±å‡ºè·¯</span><span class="v">${s.escape}</span>`;
    line.appendChild(pill);

    const btns = document.createElement("div"); btns.className="tapbtns";
    btns.appendChild(smallBtn("è­¦å¯Ÿç½² +1","good", ()=>{
      state.r.at.stage.police += 1;
      saveState(); addHist("r","ATé–‹å§‹=è­¦å¯Ÿç½² +1"); renderAll();
    }));
    btns.appendChild(smallBtn("ä¸‹æ°´é“ +1","good", ()=>{
      state.r.at.stage.sewer += 1;
      saveState(); addHist("r","ATé–‹å§‹=ä¸‹æ°´é“ +1"); renderAll();
    }));
    btns.appendChild(smallBtn("ç ”ç©¶æ‰€ +1","warn", ()=>{
      state.r.at.stage.lab += 1;
      saveState(); addHist("r","ATé–‹å§‹=ç ”ç©¶æ‰€ +1"); renderAll();
    }));
    btns.appendChild(smallBtn("è„±å‡ºè·¯ +1","warn", ()=>{
      state.r.at.stage.escape += 1;
      saveState(); addHist("r","ATé–‹å§‹=è„±å‡ºè·¯ +1"); renderAll();
    }));
    line.appendChild(btns);
    f.appendChild(line);
    const note = document.createElement("div");
    note.className="note";
    note.innerHTML = `â€» æ¯”ç‡åˆ¤å®šã¯ã€Œè­¦å¯Ÿç½² vs ä¸‹æ°´é“ã€ã‚’ä¸»ã«ä½¿ç”¨ï¼ˆL1/L2ã®å·®ãŒå‡ºã‚‹éƒ¨åˆ†ï¼‰ã€‚ç ”ç©¶æ‰€/è„±å‡ºè·¯ã¯è¨˜éŒ²ç”¨ï¼ˆè¨­å®šå·®ã¯å°ã•ã‚æ‰±ã„ï¼‰ã€‚`;
    f.appendChild(document.createElement("div")).className="hr";
    f.appendChild(note);
    two.appendChild(f);
  }

  // Direct hit (contract select)
  {
    const f = document.createElement("div");
    f.className="field";
    f.innerHTML = `<div class="label">ATç›´æ’ƒï¼ˆå¥‘æ©Ÿåˆ¥ï¼‰</div>`;
    const line = document.createElement("div"); line.className="tapline";
    const pill = document.createElement("div"); pill.className="pill";
    const d = state.r.direct;
    pill.innerHTML = `<span>åˆè¨ˆ</span><span class="v">${d.total}</span>
      <span style="opacity:.6;">ï½œ</span><span>ãƒªãƒ—</span><span class="v">${d.replay}</span>
      <span style="opacity:.6;">ï½œ</span><span>å¼±</span><span class="v">${d.weak}</span>
      <span style="opacity:.6;">ï½œ</span><span>å¼·</span><span class="v">${d.strong}</span>
      <span style="opacity:.6;">ï½œ</span><span>ä¸æ˜</span><span class="v">${d.unknown}</span>`;
    line.appendChild(pill);

    const btns = document.createElement("div"); btns.className="tapbtns";
    btns.appendChild(smallBtn("è¿½åŠ â€¦","best", ()=>{
      const kind = prompt("ç›´æ’ƒå¥‘æ©Ÿã‚’å…¥åŠ›ï¼šreplay / weak / strong / unknown\nï¼ˆä¾‹ï¼‰replay", "replay");
      if(!kind) return;
      const k = kind.trim().toLowerCase();
      if(!["replay","weak","strong","unknown"].includes(k)){
        alert("å…¥åŠ›ãŒä¸æ­£ã§ã™ã€‚replay / weak / strong / unknown ã®ã©ã‚Œã‹ã«ã—ã¦ã­ã€‚");
        return;
      }
      state.r.direct.total += 1;
      state.r.direct[k] += 1;
      // ç›´æ’ƒã¯ATã§ã‚‚ã‚ã‚‹
      state.r.at.count += 1;
      saveState();
      addHist("r", `ATç›´æ’ƒ +1ï¼ˆ${k} / AT+1ï¼‰`);
      renderAll();
    }));
    btns.appendChild(smallBtn("âˆ’1ï¼ˆä¿®æ­£ï¼‰","bad", ()=>{
      // subtract from unknown first, then others
      const order = ["unknown","strong","weak","replay"];
      if(state.r.direct.total<=0) return;
      state.r.direct.total -= 1;
      for(const k of order){
        if(state.r.direct[k]>0){ state.r.direct[k]-=1; break; }
      }
      state.r.at.count = Math.max(0, state.r.at.count-1);
      saveState();
      addHist("r","ATç›´æ’ƒ âˆ’1ï¼ˆä¿®æ­£ï¼‰");
      renderAll();
    }));
    line.appendChild(btns);
    f.appendChild(line);
    const note = document.createElement("div");
    note.className="note";
    note.innerHTML = `â€» ã€Œç›´æ’ƒã ã‘ã§ä¸Šä½ã«é£›ã°ãªã„ã€ã‚ˆã†ã«ã€åˆ¤å®šã§ã¯â€œå¼·ã‚ã®è£œåŠ©â€æ‰±ã„ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚`;
    f.appendChild(document.createElement("div")).className="hr";
    f.appendChild(note);
    two.appendChild(f);
  }

  b.appendChild(two);
  box.appendChild(b);

  // Figures input (collapsed)
  const f = document.createElement("div"); f.className="chip";
  f.innerHTML = `<h3>ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ï¼ˆå…¥åŠ›ï¼‰</h3>`;
  const det = document.createElement("details");
  det.open = false;
  const sum = document.createElement("summary");
  sum.textContent = "ã‚¿ãƒƒãƒ—ã—ã¦é–‹ãï¼ˆå…¥åŠ›ã¯å…¨éƒ¨ã“ã“ï¼‰";
  det.appendChild(sum);

  const meta = state.r.figs._meta;
  for(const item of meta){
    const field = document.createElement("div");
    field.className="field";
    field.innerHTML = `<div class="label">${item.tag}</div>`;
    const line = document.createElement("div"); line.className="tapline";
    const pill = document.createElement("div"); pill.className="pill";
    pill.innerHTML = `<span>${item.name}</span><span class="v">${state.r.figs[item.key]}</span>`;
    line.appendChild(pill);

    const btns = document.createElement("div"); btns.className="tapbtns";
    btns.appendChild(smallBtn("+1","good", ()=>{
      state.r.figs[item.key] += 1;
      saveState();
      addHist("r", `ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ +1ï¼š${item.name}ï¼ˆ${item.tag}ï¼‰`);
      renderAll();
    }));
    btns.appendChild(smallBtn("âˆ’1","bad", ()=>{
      state.r.figs[item.key] = Math.max(0, state.r.figs[item.key]-1);
      saveState();
      addHist("r", `ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ âˆ’1ï¼š${item.name}`);
      renderAll();
    }));
    line.appendChild(btns);
    field.appendChild(line);
    det.appendChild(field);
  }
  const note = document.createElement("div");
  note.className="note";
  note.innerHTML = `â€» å¦å®šå½¢ï¼ä»¥ä¸Šï¼ç¢ºå®šã¯ã€Œãã®è¨­å®šã‚’é™¤å¤–ã™ã‚‹ã ã‘ã€ã€‚ä»–è¨­å®šã«â€œåŠ ç‚¹â€ã¯ã—ã¾ã›ã‚“ï¼ˆã‚ãªãŸæŒ‡å®šï¼‰ã€‚`;
  det.appendChild(document.createElement("div")).className="hr";
  det.appendChild(note);

  f.appendChild(det);
  box.appendChild(f);

  return box;
}

function renderRE2JudgePanel(){
  const box = document.createElement("div");

  const s = computeRE2SettingPercent();
  const ex = s.excluded;
  const pct = s.pct;

  // Candidate list
  const c = document.createElement("div"); c.className="chip";
  c.innerHTML = `<h3>è¨­å®šå€™è£œï¼ˆï¼…ï¼‰</h3>`;

  const row = document.createElement("div"); row.className="krow";
  if(ex.size){
    const exb = document.createElement("div");
    exb.className="k";
    exb.textContent = `é™¤å¤–ï¼šè¨­å®š${[...ex].sort((a,b)=>a-b).join(",")}`;
    row.appendChild(exb);
  }else{
    const exb = document.createElement("div");
    exb.className="k";
    exb.textContent = "é™¤å¤–ï¼šãªã—";
    row.appendChild(exb);
  }

  const ord = Object.keys(pct).map(x=>Number(x)).sort((a,b)=> pct[b]-pct[a]);
  for(const sNo of ord){
    if(ex.has(sNo)) continue;
    const k = document.createElement("div");
    k.className="k";
    k.textContent = `è¨­å®š${sNo}ï¼š${fmtPct(pct[sNo])}`;
    row.appendChild(k);
  }
  c.appendChild(row);

  const r = document.createElement("div");
  r.className="note";
  r.innerHTML = `â€» ï¼…ã¯ã€Œå…¥åŠ›ã—ãŸè¦ç´ ã€ã ã‘ã§è¿‘ä¼¼ã€‚å¦å®šå½¢ã¯ãã®è¨­å®šã‚’0%ï¼ˆå€™è£œã‹ã‚‰é™¤å¤–ï¼‰ã«ã™ã‚‹ã®ã¿ã§ã€ä»–è¨­å®šã¸ã®åŠ ç‚¹ã¯ã—ã¾ã›ã‚“ã€‚`;
  c.appendChild(document.createElement("div")).className="hr";
  c.appendChild(r);
  box.appendChild(c);

  // Summary (hide zeros, sorted)
  const sum = document.createElement("div"); sum.className="chip";
  sum.innerHTML = `<h3>ç¢ºèªï¼ˆå‡ºãŸã‚‚ã®ã ã‘ / å¤šã„é †ï¼‰</h3>`;

  const list = summarizeFigsForView();
  if(list.length===0){
    const p = document.createElement("div");
    p.className="note";
    p.textContent = "ã¾ã ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã®å…¥åŠ›ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    sum.appendChild(p);
  }else{
    const groups = {
      odd: {title:"å¥‡æ•°ç¤ºå”†", arr:[]},
      even:{title:"å¶æ•°ç¤ºå”†", arr:[]},
      hi:{title:"é«˜è¨­å®šç¤ºå”†", arr:[]},
      deny:{title:"å¦å®šå½¢", arr:[]},
      floor:{title:"ç¢ºå®šãƒ»ä»¥ä¸Š", arr:[]},
    };
    for(const it of list) groups[it.cat].arr.push(it);

    for(const key of ["floor","deny","hi","odd","even"]){
      const g = groups[key];
      if(g.arr.length===0) continue;
      const sec = document.createElement("div");
      sec.className="field";
      sec.innerHTML = `<div class="label">${g.title}</div>`;
      const lines = document.createElement("div");
      lines.className="krow";
      for(const it of g.arr){
        const k = document.createElement("div");
        k.className="k";
        k.textContent = `${it.name} Ã—${it.count}`;
        lines.appendChild(k);
      }
      sec.appendChild(lines);
      sum.appendChild(sec);
    }
  }

  // Behavior quick stats
  const b = document.createElement("div"); b.className="chip";
  b.innerHTML = `<h3>æŒ™å‹•ï¼ˆå…¥åŠ›å€¤ï¼‰</h3>`;
  const kv = document.createElement("div");
  kv.className="krow";
  kv.appendChild(tag(`CZï¼š${state.r.cz.count}ï¼ˆæˆåŠŸ${state.r.cz.win}ï¼‰`));
  kv.appendChild(tag(`ATï¼š${state.r.at.count}`));
  kv.appendChild(tag(`ç›´æ’ƒï¼š${state.r.direct.total}ï¼ˆãƒªãƒ—${state.r.direct.replay}/å¼±${state.r.direct.weak}/å¼·${state.r.direct.strong}/ä¸æ˜${state.r.direct.unknown}ï¼‰`));
  const st = state.r.at.stage;
  kv.appendChild(tag(`ATé–‹å§‹ï¼šè­¦å¯Ÿç½²${st.police}/ä¸‹æ°´é“${st.sewer}/ç ”ç©¶æ‰€${st.lab}/è„±å‡ºè·¯${st.escape}`));
  b.appendChild(kv);
  box.appendChild(b);

  // Comments
  const cm = document.createElement("div"); cm.className="chip";
  cm.innerHTML = `<h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>`;
  const top = ord.find(x=>!ex.has(x));
  const msg = document.createElement("div");
  msg.className="note";
  msg.innerHTML = buildMotivationComment(pct, ex, top);
  cm.appendChild(msg);
  box.appendChild(cm);

  return box;

  function tag(t){
    const d = document.createElement("div");
    d.className="k";
    d.textContent = t;
    return d;
  }
}

function renderRE2DayLogPanel(){
  const box = document.createElement("div");
  const chip = document.createElement("div");
  chip.className="chip";
  chip.innerHTML = `<h3>å½“æ—¥å…¨å±¥æ­´ï¼ˆRE2ï¼‰</h3>`;
  const list = document.createElement("div");
  list.className="hist";

  const todays = state.history.filter(x=>x.day===todayStr && x.tab==="r");
  if(todays.length===0){
    const p = document.createElement("div");
    p.className="note";
    p.textContent = "å½“æ—¥ã®RE2å±¥æ­´ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚";
    chip.appendChild(p);
  }else{
    for(const it of todays){
      const div = document.createElement("div");
      div.className="item";
      const left = document.createElement("div");
      left.className="t";
      left.textContent = it.text;
      const right = document.createElement("div");
      right.className="d";
      right.innerHTML = `${it.ts} <button class="x" type="button">å‰Šé™¤</button>`;
      right.querySelector("button").onclick = ()=>delHist(it.id);
      div.appendChild(left);
      div.appendChild(right);
      list.appendChild(div);
    }
    chip.appendChild(list);
  }
  box.appendChild(chip);
  return box;
}

/* =========================
   RE2: Settings Percent (simple + stable)
   - Deny/Floor => exclusion only (NO bonus points)
========================= */
const AT_L2_RATIO = {
  1:0.188, 2:0.195, 3:0.207, 4:0.227, 5:0.242, 6:0.250
};

function computeRE2SettingPercent(){
  const excluded = new Set();

  // Exclusions from figures (deny/floor/confirm)
  const f = state.r.figs;
  if(f.eq6>0){
    [1,2,3,4,5].forEach(x=>excluded.add(x));
  }
  if(f.ge5>0){ [1,2,3,4].forEach(x=>excluded.add(x)); }
  if(f.ge4>0){ [1,2,3].forEach(x=>excluded.add(x)); }
  if(f.ge3>0){ [1,2].forEach(x=>excluded.add(x)); }

  if(f.deny1>0) excluded.add(1);
  if(f.deny2>0) excluded.add(2);
  if(f.deny3>0) excluded.add(3);
  if(f.deny4>0) excluded.add(4);

  // Base scores
  const scores = {1:0,2:0,3:0,4:0,5:0,6:0};
  for(const s of [1,2,3,4,5,6]){
    if(excluded.has(s)) scores[s] = -1e15; // effectively -inf
  }

  // Early factor (<=1000G)
  const totalG = Number(state.r.totalG||0);
  const early = (totalG>0 && totalG<=1000) ? 1.2 : 1.0;

  // 1) AT Level ratio from stage starts: police vs sewer only
  const st = state.r.at.stage;
  const n = st.police + st.sewer;
  const k = st.sewer; // treat sewer-start as Lv2 signal
  if(n >= 2){
    const wAT = clamp(n/8, 0, 1); // sample size damping
    for(const s of [1,2,3,4,5,6]){
      if(excluded.has(s)) continue;
      const p = AT_L2_RATIO[s];
      // log likelihood (binomial without comb term)
      const ll = k*Math.log(p) + (n-k)*Math.log(1-p);
      scores[s] += ll * wAT;
    }
  }

  // 2) Figure points (parity + hi only; caps)
  // parity caps: weak up to 20, strong up to 20
  const oddPts = clamp(f.oddWeak*1 + f.oddStrong*2, 0, 20);
  const evenPts = clamp(f.evenWeak*1 + f.evenStrong*2, 0, 20);
  const hiPts = (f.hiWeak*1 + f.hiStrong*2); // no cap (as per your preference earlier)

  // apply: odd => {1,3,5}; even => {2,4,6}; hi => {4,5,6}
  const wFig = 1.0;
  for(const s of [1,2,3,4,5,6]){
    if(excluded.has(s)) continue;
    // parity gentle (do not overpower)
    const parityAdd = (s%2===1 ? oddPts : evenPts) * 0.05;
    scores[s] += parityAdd * wFig;
    // high setting hint
    if([4,5,6].includes(s)){
      scores[s] += hiPts * 0.08 * wFig;
    }
  }

  // 3) Direct hits (strong helper, capped)
  const d = state.r.direct;
  const eff = Math.min(d.total, 2); // cap
  if(eff>0){
    const wDirect = 0.6 * early; // stronger early, but still helper
    const wByS = {1:0.05,2:0.10,3:0.20,4:0.60,5:0.75,6:0.85};
    for(const s of [1,2,3,4,5,6]){
      if(excluded.has(s)) continue;
      scores[s] += eff * wByS[s] * wDirect;
    }
  }

  // 4) CZ/AT general behavior (light)
  // just a gentle push if CZ success exists early
  const cz = state.r.cz;
  if(cz.count >= 4){
    const succRate = cz.win / cz.count;
    const wBeh = 0.35 * early;
    // higher success rate slightly supports higher settings
    for(const s of [1,2,3,4,5,6]){
      if(excluded.has(s)) continue;
      const base = (s-1)/5; // 0..1
      scores[s] += (succRate - 0.25) * base * wBeh;
    }
  }

  const pct = softmax(scores);

  // explicit 0% for excluded (presentation safety)
  for(const s of [1,2,3,4,5,6]){
    if(excluded.has(s)) pct[s] = 0;
  }

  return { pct, excluded };
}

/* =========================
   Figure summary for judge view:
   - hide 0
   - sort by count desc
========================= */
function summarizeFigsForView(){
  const meta = state.r.figs._meta;
  const out = [];
  for(const it of meta){
    const c = Number(state.r.figs[it.key]||0);
    if(c<=0) continue;
    out.push({ key:it.key, name:it.name, tag:it.tag, cat:it.cat, count:c });
  }
  out.sort((a,b)=> b.count-a.count);
  return out;
}

/* =========================
   Motivation comment (simple)
========================= */
function buildMotivationComment(pct, excluded, top){
  const totalG = Number(state.r.totalG||0);
  const early = (totalG>0 && totalG<=1000);

  if(top==null) return "å…¥åŠ›ãŒå°‘ãªã„ãŸã‚åˆ¤å®šãŒã§ãã¾ã›ã‚“ã€‚ã¾ãšã¯CZ/AT/ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚’å°‘ã—ã ã‘å…¥ã‚Œã¦ã¿ã¦ã­ã€‚";
  const topP = pct[top]||0;

  if(excluded.size>=3 && topP>0.85){
    return "å¦å®š/ç¢ºå®šç³»ãŒå¼·ãå‡ºã¦ã‚‹ã­ã€‚å€™è£œãŒã‹ãªã‚Šçµã‚Œã¦ã‚‹ã‹ã‚‰ã€ä»Šæ—¥ã¯å®‰å¿ƒã—ã¦ç«‹ã¡å›ã‚Šã‚„ã™ã„ã¨æ€ã†ã€‚";
  }
  if(early){
    return "åºç›¤ã¯ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ãŒæºœã¾ã‚Šã«ãã„ã‹ã‚‰ã€æŒ™å‹•ï¼ˆCZâ†’ATã€ç›´æ’ƒã€ATé–‹å§‹ã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰ã‚’å¼·ã‚ã«è¦‹ã¦OKã€‚ãƒ ãƒªã«æ±ºã‚æ‰“ã¡ã—ãªã„ã§ã€è‰¯ã„æ ¹æ‹ ãŒå¢—ãˆãŸã‚‰è¿½ã†æ„Ÿã˜ã§ã„ã“ã€‚";
  }
  if(topP>=0.55){
    return "ä»Šã®å…¥åŠ›ã ã¨ä¸Šä½å€™è£œãŒã¯ã£ãã‚Šã—ã¦ããŸã‚ˆã€‚ä¸‹æŒ¯ã‚Œã§å¿ƒãŒæŠ˜ã‚Œãã†ã§ã‚‚ã€æ ¹æ‹ ãŒç©ã‚ã¦ã‚‹ãªã‚‰ç²˜ã‚‹ç†ç”±ã«ãªã‚‹ã€‚";
  }
  if(topP>=0.35){
    return "å€™è£œãŒå‰²ã‚Œã¦ã‚‹æ„Ÿã˜ã€‚ã‚‚ã†å°‘ã—ææ–™ï¼ˆATé–‹å§‹ã‚¹ãƒ†ãƒ¼ã‚¸ã€ç›´æ’ƒã€ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ï¼‰ã‚’ç©ã‚€ã¨ç²¾åº¦ä¸ŠãŒã‚‹ã‚ˆã€‚ç„¦ã‚‰ãšã„ã“ã€‚";
  }
  return "ã¾ã åˆ¤æ–­ææ–™ãŒè–„ã‚ã€‚ä½è¨­å®šã®ä¸ŠæŒ¯ã‚Œï¼é«˜è¨­å®šã®ä¸‹æŒ¯ã‚Œã‚’è¦‹èª¤ã‚Šã‚„ã™ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã ã‹ã‚‰ã€æ ¹æ‹ ãŒå¢—ãˆã‚‹ã¾ã§ã¯å®ˆã‚Šå¯„ã‚ŠãŒå®‰å¿ƒã€‚";
}

/* =========================
   Right Panel (global)
========================= */
function renderRight(){
  const judgeBox = document.getElementById("judgeBox");
  judgeBox.innerHTML = "";

  // Global judge: show per active tab
  const res = (state.activeTab==="k") ? judgeKabaneriSimple() : judgeRE2FromPercent();

  const rankDiv = document.createElement("div");
  rankDiv.className = "rank";

  const badge = document.createElement("div");
  badge.className = "badge " + (
    res.rank==="red" ? "b-red" :
    res.rank==="yellow" ? "b-yellow" :
    res.rank==="green" ? "b-green" : "b-purple"
  );
  badge.textContent = res.badge;

  rankDiv.appendChild(badge);

  const info = document.createElement("div");
  info.className = "sub";
  info.textContent = res.sub;
  rankDiv.appendChild(info);

  judgeBox.appendChild(rankDiv);

  const reason = document.createElement("div");
  reason.className="reason";
  const ul = document.createElement("ul");
  for(const r of res.reasons){
    const li = document.createElement("li");
    li.textContent = r;
    ul.appendChild(li);
  }
  reason.appendChild(ul);
  judgeBox.appendChild(reason);

  // History: show only today's, last 10
  const hist = document.getElementById("hist");
  hist.innerHTML = "";
  const todays = state.history.filter(x=>x.day===todayStr);
  const show = todays.slice(0,10);
  if(show.length===0){
    const p = document.createElement("div");
    p.className="note";
    p.textContent = "ã¾ã å½“æ—¥å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã®ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¨˜éŒ²ã—ã¦ã­ã€‚";
    hist.appendChild(p);
  }else{
    for(const it of show){
      const div = document.createElement("div");
      div.className="item";
      const left = document.createElement("div");
      left.className="t";
      left.textContent = (it.tab==="k"?"[ã‚«ãƒãƒãƒª] ":"[RE2] ") + it.text;
      const right = document.createElement("div");
      right.className="d";
      right.innerHTML = `${it.ts} <button class="x" type="button">å‰Šé™¤</button>`;
      right.querySelector("button").onclick = ()=>delHist(it.id);
      div.appendChild(left);
      div.appendChild(right);
      hist.appendChild(div);
    }
  }
}

/* =========================
   Simple judges for right panel
========================= */
function judgeKabaneriSimple(){
  const k = state.k;
  if(k.bonus.epi7>0){
    return {
      rank:"purple",
      badge:"ğŸŸ£ é«˜è¨­å®šæ¿ƒåš",
      sub:"ã‚«ãƒãƒãƒªï¼š7è©±ç¢ºèªï¼ˆè¨­å®š4ä»¥ä¸Šç¢ºå®šï¼‰",
      reasons:[`ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰7è©±ï¼š${k.bonus.epi7}å›ï¼ˆè¨­å®š4ä»¥ä¸Šç¢ºå®šï¼‰`]
    };
  }
  const czTot = k.cz.unmei.a + k.cz.ikoma.a + k.cz.biba.a;
  let rank="yellow", badge="ğŸŸ¡ å‚è€ƒè¡¨ç¤º", sub="ã‚«ãƒãƒãƒªï¼šç°¡æ˜“ï¼ˆCZ/é§¿åŸ/EPä¸­å¿ƒï¼‰";
  if(k.bonus.sjo>=3 && czTot>=6){ rank="green"; badge="ğŸŸ¢ é«˜è¨­å®šæœŸå¾…"; }
  if(czTot===0 && k.bonus.sjo===0){ rank="yellow"; badge="ğŸŸ¡ ææ–™ä¸è¶³"; }
  return {
    rank, badge, sub,
    reasons:[
      `CZå‡ºç¾ï¼šåˆè¨ˆ${czTot}å›ï¼ˆç„¡å${k.cz.unmei.a}/ç”Ÿé§’${k.cz.ikoma.a}/ç¾é¦¬${k.cz.biba.a}ï¼‰`,
      `é§¿åŸãƒœãƒ¼ãƒŠã‚¹ï¼š${k.bonus.sjo}å›`,
      "â€» è©³ç´°åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯RE2å´ã‚’å„ªå…ˆã—ã¦ä½œã‚Šè¾¼ã‚“ã§ã„ã¾ã™ï¼ˆå¿…è¦ãªã‚‰ã‚«ãƒãƒãƒªã‚‚å¼·åŒ–OKï¼‰ã€‚"
    ]
  };
}

function judgeRE2FromPercent(){
  const {pct, excluded} = computeRE2SettingPercent();
  const ord = [1,2,3,4,5,6].filter(s=>!excluded.has(s)).sort((a,b)=>pct[b]-pct[a]);
  const top = ord[0];
  const topP = pct[top]||0;

  let rank="yellow", badge="ğŸŸ¡ ä¸­é–“ã®å¯èƒ½æ€§ã‚ã‚Š";
  if(topP>=0.60) { rank="green"; badge="ğŸŸ¢ é«˜è¨­å®šæœŸå¾…"; }
  if(state.r.figs.eq6>0){ rank="purple"; badge="ğŸŸ£ è¨­å®š6ç¢ºå®š"; }
  else if(state.r.figs.ge5>0){ rank="purple"; badge="ğŸŸ£ è¨­å®š5ä»¥ä¸Š"; }

  const reasons = [];
  if(excluded.size){
    reasons.push(`é™¤å¤–ï¼šè¨­å®š${[...excluded].sort((a,b)=>a-b).join(",")}ï¼ˆå¦å®š/ç¢ºå®šç³»ï¼‰`);
  }
  if(top!=null){
    reasons.push(`å€™è£œ1ä½ï¼šè¨­å®š${top}ï¼ˆ${fmtPct(topP)}ï¼‰`);
    const second = ord[1];
    if(second!=null) reasons.push(`å€™è£œ2ä½ï¼šè¨­å®š${second}ï¼ˆ${fmtPct(pct[second])}ï¼‰`);
  }
  reasons.push("â€» å¦å®šå½¢ã¯â€œãã®è¨­å®šã‚’é™¤å¤–ã™ã‚‹ã ã‘â€ã€‚ä»–è¨­å®šã«åŠ ç‚¹ã¯ã—ã¾ã›ã‚“ï¼ˆã‚ãªãŸæŒ‡å®šï¼‰ã€‚");

  return {
    rank, badge,
    sub:"RE2ï¼šï¼…ã¯å…¥åŠ›ãƒ™ãƒ¼ã‚¹ã®è¿‘ä¼¼ï¼ˆå®Ÿæˆ¦å‘ã‘ã«æš´ã‚Œã‚’æŠ‘åˆ¶ï¼‰",
    reasons
  };
}

/* =========================
   Buttons: reset / export / import
========================= */
document.getElementById("btnResetDay").addEventListener("click", ()=>{
  if(confirm("å½“æ—¥ã®å…¥åŠ›ã¨å½“æ—¥å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ")){
    resetDay();
  }
});
document.getElementById("btnExport").addEventListener("click", ()=>{
  const payload = {
    exported_at: new Date().toISOString(),
    app: "kabare2_v2",
    state
  };
  downloadJSON(payload, `kabare2_${todayStr}.json`);
});
document.getElementById("btnImport").addEventListener("click", ()=>{
  document.getElementById("fileIn").click();
});
document.getElementById("fileIn").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const obj = JSON.parse(txt);
    if(!obj || !obj.state) throw new Error("invalid");
    state = obj.state;

    // day rollover handling
    if(state.day !== todayStr){
      state.day = todayStr;
      state.k = defaultKState();
      state.r = defaultRState();
    }

    // ensure metas exist
    if(!state.r?.figs?._meta){
      const fixed = initRE2Figs();
      if(state.r?.figs){
        for(const k of Object.keys(fixed)){
          if(k==="_meta") continue;
          fixed[k] = Number(state.r.figs[k]||0);
        }
      }
      state.r.figs = fixed;
    }
    if(!state.r.ui) state.r.ui = { subtab:"input" };
    if(!state.r.direct) state.r.direct = { total:0, replay:0, weak:0, strong:0, unknown:0 };
    if(!state.r.at) state.r.at = { count:0, stage: {police:0, sewer:0, lab:0, escape:0} };

    saveState();
    renderAll();
    alert("èª­ã¿è¾¼ã¿å®Œäº†ï¼");
  }catch(err){
    alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ã­ã€‚");
  }finally{
    e.target.value = "";
  }
});

/* =========================
   Init
========================= */
renderAll();
</script>
</body>
</html>
